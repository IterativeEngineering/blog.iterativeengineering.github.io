<!DOCTYPE html><html lang="en"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Creating optimised Docker Images using Multi-Stage Builds</title><meta property="og:title" content="Creating optimised Docker Images using Multi-Stage Builds"><meta property="og:site_name" content="Iterative Engineering Blog"><meta name="author" content="Iterative Engineering Team"><meta property="og:locale" content="en_GB"><meta property="og:description" content="What are the reasons and how to use Docker Multi-Stage builds"><meta property="description" content="What are the reasons and how to use Docker Multi-Stage builds"><meta property="og:url" content="https://blog.iterative.engineering/2021/09/28/creating-optimised-docker-images-using-multi-stage-builds/"><meta property="og:image" content="https://blog.iterative.engineering/assets/images/creating-optimised-docker-images-using-multi-stage-builds/multistage-docker.jpg"><meta name="twitter:url" content="https://blog.iterative.engineering/2021/09/28/creating-optimised-docker-images-using-multi-stage-builds/"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Creating optimised Docker Images using Multi-Stage Builds | Iterative Engineering Blog"><meta name="twitter:site" content="Iterative Engineering Blog"><meta name="twitter:description" content="What are the reasons and how to use Docker Multi-Stage builds"><link rel="canonical" href="https://iterative.engineering"><link rel="shortcut icon" href="/assets/images/favicon.png"/><link rel="stylesheet" href="/assets/css/app.min.css?14596efc646507d9d188130d517c746d"><link rel="alternate" type="application/rss+xml" title="Iterative Engineering Blog" href="/feed.xml"><link rel="canonical" href="/2021/09/28/creating-optimised-docker-images-using-multi-stage-builds/"> <script defer type="text/javascript" src="https://widget.clutch.co/static/js/widget.js"></script> <script defer type="text/javascript" src="/assets/js/main.js?14596efc646507d9d188130d517c746d"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-68442502-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-68442502-1'); </script> <script> (function () { window.ldfdr = window.ldfdr || {}; (function (d, s, ss, fs) { fs = d.getElementsByTagName(s)[0]; function ce(src) { var cs = d.createElement(s); cs.src = src; setTimeout(function () { fs.parentNode.insertBefore(cs, fs) }, 1); } ce(ss); })(document, 'script', 'https://sc.lfeeder.com/lftracker_v1_lYNOR8xMKOG7WQJZ.js'); })(); </script> <script type="text/javascript"> (function (c, l, a, r, i, t, y) { c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) }; t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i; y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y); })(window, document, "clarity", "script", "4g6s96579b"); </script> <script> function toggleClass() { const mobileMenu = document.querySelector('.mobile_menu-container'); mobileMenu.classList.toggle('toggleMenu'); const hambBcg = document.querySelector('.hamburger'); hambBcg.classList.toggle('hamburger_changeBcg'); } </script></head><body id="creating-optimised-docker-images-using-multi-stage-builds" class="post-layout"><header class="header"><div class="container"><nav class="navbar"> <a href="/" class="logo_wrapper-1920-xx"> <img src="/assets/images/nav/logo-without-blog.svg" alt="logo" /> </a> <a href="/" class="logo_wrapper"> <img src="/assets/images/nav/logo-all.svg" alt="logo" /> </a><ul class="menu"><li><a style="font-weight: bold" href="/category/business">Business</a></li><li><a style="font-weight: bold" href="/category/technical">Technical</a></li><li><a style="font-weight: bold" href="/category/lifestyle">Lifestyle</a></li><li> <a id="homepage_btn" style="background-color: rgb(95, 103, 170);padding: 0 32px; font-weight: bold; color:white" href="https://iterative.engineering" >Go to a main page</a ></li></ul><div onclick="toggleClass()" class="hamburger"> <span class="hamb_bar"></span></div></nav><div class="mobile_menu-container"><ul class="menu_mobile"><li><a href="#">Business</a></li><li><a href="#">Technical</a></li><li><a href="#">Lifestyle</a></li><li> <a style="background-color: rgb(95, 103, 170); color:white" href="https://iterative.engineering">Go to a main page</a></li></ul></div></div></header><main><div class="post"><article itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting"><div class="post__header section-padding--double"><div class="grid-small"><h2 itemprop="name headline">Creating optimised Docker Images using Multi-Stage Builds</h2><time class="post__date" datetime="2021-09-28T00:00:00+02:00" itemprop="datePublished">28 Sep 2021</time></div></div><div class="post__img"><div><figure class="absolute-bg" style="background-image: url('/assets/images/creating-optimised-docker-images-using-multi-stage-builds/multistage-docker.jpg');"></figure></div></div><div class="post__content section-padding"><div class="grid"><div id="markdown" itemprop="articleBody"><p>Have you ever wondered how you can leverage building docker containers in your project to take your experience to the next level? If so then have a look at this step by step guide that hopefully will help you achieve that goal using multi-stage builds.</p><p><em>If you would like to preview the code used in this article, just clone <a href="https://github.com/IterativeEngineering/blog.docker-multistage-builds">this repository</a>.</em></p><h2 id="why-use-multi-stage-builds">Why use Multi-Stage builds?</h2><p>In a nutshell multi-stage builds feature is a recent improvement to the docker build system</p><ul><li>final image sizes</li><li>image build orchestration</li></ul><p>The refinement is achieved via allowing to consecutively use different images (for whatever purpose is needed) and pipe data subsequently through them within a single Dockerfile with assumption that the final image is built based on the last FROM statement.</p><h2 id="standard-approach">Standard approach</h2><p>If you already worked with a docker, you certainly faced the problem of large built images or had to do custom shell scripts to orchestrate build. Each instruction in the dockerfile adds another layer to the image which increases its size. Moreover, creating more complex images may require the use of additional shell scripts and multiple dockerfiles which may be cumbersome to manage.</p><p>To illustrate the above issues, I’ve created a simple java web application that I am going to build and run in a docker container. By default, without using multistage builds, the dockerfile would look like this:</p><div class="language-docker highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Dockerfile.singlestage</span>
<span class="k">FROM</span><span class="s"> registry.access.redhat.com/ubi8/openjdk-11:1.3</span>
<span class="k">WORKDIR</span><span class="s"> /deployments</span>
<span class="k">COPY</span><span class="s"> . /deployments</span>
<span class="k">RUN </span>mvn package
<span class="k">EXPOSE</span><span class="s"> 8080</span>
<span class="k">CMD</span><span class="s"> ["java", "-jar", "target/demo-webapp-0.0.1-SNAPSHOT.jar"]</span>
</code></pre></div></div><p>In the above file we perform following steps:</p><ol><li>Create a new image based on the redhat’s <em>universal base image</em> that already contains openjdk-11.</li><li>Create the <em>/deployments</em> working directory and then copy the content of our project to it.</li><li>Build java archive file with maven</li><li>Run java application from command line</li></ol><p>Since we already have the Dockerfile prepared, we can start building the image with the following command:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker build <span class="nt">-t</span> demo-webapp:singlestage <span class="nt">-f</span> Dockerfile.singlestage <span class="nb">.</span>
</code></pre></div></div><p>Afterwards we can check the result:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker images

<span class="c">## _REPOSITORY 		TAG 		IMAGE ID 		CREATED 		SIZE</span>
demo-webapp		singlestage	491de71ef224		24 seconds ago		549MB
</code></pre></div></div><h2 id="build-an-image-using-builder-pattern--shell-script">Build an image using builder pattern &amp; shell script</h2><p>The newly created image that runs our application is quite large, so let’s optimize it using the builder pattern. For this purpose, we need to create 2 separate dockerfiles - one responsible for building the application and the other for launching it. Thanks to this approach, the final runner container may contain only elements that are important to us.</p><div class="language-docker highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Dockerfile.builder</span>
<span class="k">FROM</span><span class="s"> registry.access.redhat.com/ubi8/openjdk-11:1.3</span>
<span class="k">WORKDIR</span><span class="s"> /deployments</span>
<span class="k">COPY</span><span class="s"> . /deployments</span>
<span class="k">RUN </span>mvn package
<span class="c"># Dockerfile.runner</span>
<span class="k">FROM</span><span class="s"> gcr.io/distroless/java:11</span>
<span class="k">COPY</span><span class="s"> ./deployments/target/demo-webapp-0.0.1-SNAPSHOT.jar .</span>
<span class="k">EXPOSE</span><span class="s"> 8080</span>
<span class="k">CMD</span><span class="s"> ["demo-webapp-0.0.1-SNAPSHOT.jar"]</span>
</code></pre></div></div><p>To automate the process of building images defined in separate dockerfiles, we create a shell script that carries out the steps necessary to run our application.</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">echo</span> <span class="s2">"Building demo-webapp builder image..."</span>
docker build <span class="nt">-t</span> demo-webapp:singlestage-builder <span class="nt">-f</span> Dockerfile.builder <span class="nb">.</span>
<span class="nb">echo</span> <span class="s2">"Extracting builder content..."</span>
docker container create <span class="nt">--name</span> extract-builder demo-webapp:singlestage-builder
docker container <span class="nb">cp </span>extract-builder:/deployments <span class="nb">.</span>
docker container <span class="nb">rm</span> <span class="nt">-f</span> extract-builder
<span class="nb">echo</span> <span class="s2">"Building demo-webapp runner image..."</span>
docker build <span class="nt">-t</span> demo-webapp:singlestage-runner <span class="nt">-f</span> Dockerfile.runner <span class="nb">.</span>
</code></pre></div></div><p>After executing the <em>build.sh</em> script, we can notice that 2 images were created and the final (runner) image is much smaller than before. It is a very big advantage, because you only need to transfer the runner image during application release in the future.</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## _REPOSITORY 		TAG 			IMAGE ID 	CREATED 		SIZE</span>
demo-webapp		singlestage-runner	5fd438ae9faa	9 seconds ago		217MB
demo-webapp		singlestage-builder	f6e90caab67b	10 seconds ago		532MB
</code></pre></div></div><h2 id="multi-stage-build">Multi-stage build</h2><p>Along with the implementation of version 17.05, docker provided the multi-stage build functionality which allows you to divide the creation of the container into several phases and build it as several separate images that have access to each other. To take advantage of multistage builds, we need to create a new dockerfile.</p><div class="language-docker highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Dockerfile.multistage</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">registry.access.redhat.com/ubi8/openjdk-11:1.3</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">builder</span>
<span class="k">WORKDIR</span><span class="s"> /deployments</span>
<span class="k">COPY</span><span class="s"> . /deployments</span>
<span class="k">RUN </span>mvn package
<span class="k">FROM</span><span class="w"> </span><span class="s">gcr.io/distroless/java:11</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">runner</span>
<span class="k">COPY</span><span class="s"> --from=builder /deployments/target/demo-webapp-0.0.1-SNAPSHOT.jar .</span>
<span class="k">EXPOSE</span><span class="s"> 8080</span>
<span class="k">CMD</span><span class="s"> ["demo-webapp-0.0.1-SNAPSHOT.jar"]</span>
</code></pre></div></div><p>As of now dockerfile contains two <em>FROM</em> clauses and it will build 2 separate images consecutively - the first <em>builder</em> and the second, <em>runner</em>.</p><p>When building the <em>builder</em> image we execute almost exactly the same commands as in the case of executing the build using the single-stage build. The difference is the application startup command, which will be invoked by the <em>runner image</em>. So let’s try to run it.</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker build <span class="nt">-t</span> demo-webapp:multistage <span class="nt">-f</span> Dockerfile.multistage <span class="nb">.</span>
</code></pre></div></div><p>After calling the <em>docker images</em> command, we can see that also this time two images were created. However, we didn’t need to write additional shell scripts for this.</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## _REPOSITORY 		TAG 		IMAGE ID 		CREATED 		SIZE</span>
demo-webapp		multistage	44af0173ce49		8 seconds ago		217MB
&lt;none&gt; 		&lt;none&gt;			4969b156508a		8 seconds ago		549MB
</code></pre></div></div><h2 id="conclusions">Conclusions</h2><p>As you can see, the multi-stage approach has many advantages:</p><ul><li>Easier management of the image creation process (thanks to the possibility of including instructions for several related images in a single dockerfile)</li><li>No need to create shell scripts to automate the entire process.</li><li>Saving disk space (By using the builder container as a common base for subsequent containers)</li><li>Reducing the size of the final runtime container</li></ul><p>That’s it! We hope you found “Creating optimised Docker Images using Multi-Stage Builds” helpful in your devops activities.</p><p>If this topic interests you, visit <a href="https://docs.docker.com/develop/develop-images/multistage-build/">use multi-stage builds</a> for more details or even better <a href="https://calendly.com/krzysztof-gasior">talk to our team</a> today.</p></div><ul class="post__social"><li><a href="https://www.facebook.com/sharer/sharer.php?u=https://blog.iterative.engineering/2021/09/28/creating-optimised-docker-images-using-multi-stage-builds/" target="_blank"><i class="fa fa-facebook"></i></a></li><li><a href="https://twitter.com/intent/tweet?&text=Creating optimised Docker Images using Multi-Stage Builds+https://blog.iterative.engineering/2021/09/28/creating-optimised-docker-images-using-multi-stage-builds/+by+Paweł Nowosielski" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?mini=true&source=Creating optimised Docker Images using Multi-Stage Builds&summary=What are the reasons and how to use Docker Multi-Stage builds&url=https://blog.iterative.engineering/2021/09/28/creating-optimised-docker-images-using-multi-stage-builds/" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="https://www.reddit.com/submit?url=https://blog.iterative.engineering/2021/09/28/creating-optimised-docker-images-using-multi-stage-builds/" target="_blank"><i class="fa fa-reddit-alien"></i></a></li></ul></div></div><div class="section-padding--none"><div class="grid"><hr class="sep"/></div></div><div class="section-padding"><div class="grid-small"> Posted by<div class="post__author"> <img src="/assets/images/team/pn.png" alt="Paweł Nowosielski from Iterative Engineering"> <span> Paweł Nowosielski<p class="post__bio">Software Engineer @ Iterative Engineering</p></span></div></div></div></article></div><section class="related section-padding"><div class="grid-xlarge"><h2 class="related__title">Related</h2><div class="related__container"><article class="related__post"> <a class="related__link" href="https://blog.iterative.engineering/2021/09/28/creating-optimised-docker-images-using-multi-stage-builds/"><figure class="related__img"> <img src="/assets/images/creating-optimised-docker-images-using-multi-stage-builds/multistage-docker.jpg" alt="Creating optimised Docker Images using Multi-Stage Builds"/></figure><div><h2 class="related__text">Creating optimised Docker Images using Multi-Stage Builds</h2></div></a></article></div></div></section></main><div class="cookies"><div class="cookies-text"> This site uses "cookie" files, You can find more information here: <a href="cookies-policy.html" target="_blank" rel="noopener noreferrer nofollow" > cookies policy</a >. If you do not agree to store information in cookies, please change your browser settings.</div><div class="confirm-cookies" aria-hidden="true">I understand and accept</div></div><footer class="footer_container"><div class="main_content-wrapper"><div class="main_content"><div class="column-left"><div class="headquarter"><h4 class="headers">HEADQUARTERS</h4><div class="address text_line-spacing"> <img class="column_left-icon" src="/assets/images/icons/location-pin-icon.svg" alt="location" /><div class="location"> <span>&nbsp;ul. Wolności 191/311</span> <span>&nbsp;41-800 Zabrze, Silesia,</span> <span>&nbsp;Poland</span></div></div><div class="text_line-spacing"> <img class="column_left-icon" src="/assets/images/icons/mail-icon.svg" alt="email" /> <a class="text-hover" href="mailto:contact@iterative.pl" >office@iterative.pl</a ></div></div><div class="business-development"><h4 class="headers">BUSINESS DEVELOPMENT</h4><div class="text_line-spacing"> <img class="column_left-icon" src="/assets/images/icons/person-icon.svg" alt="email" /> <span>Krzysztof Gąsior</span></div><div> <img class="column_left-icon" src="/assets/images/icons/phone-icon.svg" alt="email" /> <a class="text_line-spacing text-hover" href="tel:+48 793 901 086" >+48 793 901 086</a ></div><div class="contact-meeting"> <img class="column_left-icon" src="/assets/images/icons/mail-icon.svg" alt="email" /> <a class="text_line-spacing text-hover" href="mailto:krzysztof.gasior@iterative.pl" >krzysztof.gasior@iterative.pl</a > <a class="link_schedule-meeting" href="https://calendly.com/krzysztof-gasior/" target="_blank" > <button class="schedule-meeting">Schedule a meeting</button> </a></div></div><div class="clutch-widget" data-url="https://widget.clutch.co" data-widget-type="2" data-height="45" data-theme="white" data-clutchcompany-id="746552" ></div></div><div class="separator"></div><div class="right-column"><div class="find-out"><h4 class="headers">FIND OUT WHAT WE WRITE ABOUT</h4><a class="text_line-spacing text-hover" href="/2022/08/08/contract-testing-with-spring/" >Contract testing with Spring</a ><br /> <a class="text_line-spacing text-hover" href="/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/" >Secure Spring Boot Application with Microsoft Azure AD</a ><br /> <a class="text_line-spacing text-hover" href="/2021/12/20/how-to-keep-the-team-integrated/" >How to keep the team integrated despite physical distance</a ><br /> <a class="text_line-spacing text-hover" href="/2021/12/10/key-8-takeaways-from-stackoverflow-2021-developers-survey/" >Key 8 Takeaways from Stack Overflow 2021 Developers Survey</a ><br /> <a class="text_line-spacing text-hover" href="/2021/09/28/creating-optimised-docker-images-using-multi-stage-builds/" >Creating optimised Docker Images using Multi-Stage Builds</a ><br /> <a class="text_line-spacing text-hover" href="/category/business/" >more...</a ></div><div class="discover-offer"><h4 class="headers">DISCOVER OUR OFFER</h4><a class="text_line-spacing text-hover" href="https://iterative.engineering/software-development-for-london-based-companies" >Software Development for London Based Companies</a ><br /> <a class="text_line-spacing text-hover" href="https://iterative.engineering/software-development-for-aberdeen-based-companies" >Software Development for Aberdeen Based Companies</a ><br /> <a class="text_line-spacing text-hover" href="https://iterative.engineering/digital-product-development-for-fintech" >Digital Product Development for Fintech</a ></div><div class="menu_footer"><h4 class="headers">Menu</h4><a class="text_line-spacing text-hover" href="/">Home</a><br /> <a class="text_line-spacing text-hover" href="/">About us</a><br /> <a class="text_line-spacing text-hover" href="/">Services</a><br /> <a class="text_line-spacing text-hover" href="/">Blog</a></div></div></div></div><div class="bottom_bar-container"><div class="bottom_bar-policy-social"><div class="bottom_bar-policy-info"><div class="company-info"><div class="bottom_bar-copyrights"> <img class="bottom_bar-copyright-icon" src="/assets/images/icons/copyright.svg" /> <span class="bottom_bar-text bottom_bar-rights_text"> 2023 Iterative Engineering Sp. z o.o. - All rights reserved </span></div><span class="bottom_bar-text" >VAT-EU: PL6482804153 | REGON: 388898977 | KRS: 0000900004 </span></div><div class="policy_container"> <a class="bottom_bar-text" href="cookies-policy.html" target="_blank" rel="noopener noreferrer nofollow" >Cookies policy</a > <a class="bottom_bar-text" href="privacy-policy.html" target="_blank" rel="noopener noreferrer nofollow" >Privacy policy</a ></div></div><div class="bottom_bar-social-icons"> <a href="https://clutch.co/profile/iterative-engineering#summary" target="_blank" rel="noopener noreferrer nofollow" > <img class="social-icons" src="/assets/images/icons/clutch-icon.svg" alt="clutch profile" /> </a> <a href="https://github.com/IterativeEngineering" target="_blank" rel="noopener noreferrer nofollow" > <img class="social-icons" src="/assets/images/icons/github-icon.svg" alt="github profile" /> </a> <a href="https://www.facebook.com/IterativeEngineering/" target="_blank" rel="noopener noreferrer nofollow" > <img class="social-icons" src="/assets/images/icons/fb-icon.svg" alt="facebook profile" /> </a> <a href="https://linkedin.com/company/11263564/" target="_blank" rel="noopener noreferrer nofollow" > <img class="social-icons" src="/assets/images/icons/linkedin-icon.svg" alt="linkedin profile" /> </a></div></div></div></footer><script src="/assets/js/app.min.js?14596efc646507d9d188130d517c746d"></script></body></html>
  