<!DOCTYPE html><html lang="en"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Contract testing with Spring</title><meta property="og:title" content="Contract testing with Spring"><meta property="og:site_name" content="Iterative Engineering Blog"><meta name="author" content="Iterative Engineering Team"><meta property="og:locale" content="en_GB"><meta property="og:description" content="A step-by-step guide on how to create effective test infrastructure for your services using Spring Cloud Contract."><meta property="description" content="A step-by-step guide on how to create effective test infrastructure for your services using Spring Cloud Contract."><meta property="og:url" content="https://blog.iterative.engineering/2022/08/08/contract-testing-with-spring/"><meta property="og:image" content="https://blog.iterative.engineering/assets/images/contract-testing-with-spring/contract-testing-with-spring.png"><meta name="twitter:url" content="https://blog.iterative.engineering/2022/08/08/contract-testing-with-spring/"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Contract testing with Spring | Iterative Engineering Blog"><meta name="twitter:site" content="Iterative Engineering Blog"><meta name="twitter:description" content="A step-by-step guide on how to create effective test infrastructure for your services using Spring Cloud Contract."><link rel="canonical" href="https://iterative.engineering"><link rel="shortcut icon" href="/assets/images/favicon.png"/><link rel="stylesheet" href="/assets/css/app.min.css?14596efc646507d9d188130d517c746d"><link rel="alternate" type="application/rss+xml" title="Iterative Engineering Blog" href="/feed.xml"><link rel="canonical" href="/2022/08/08/contract-testing-with-spring/"> <script defer type="text/javascript" src="https://widget.clutch.co/static/js/widget.js"></script> <script defer type="text/javascript" src="/assets/js/main.js?14596efc646507d9d188130d517c746d"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-68442502-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-68442502-1'); </script> <script> (function () { window.ldfdr = window.ldfdr || {}; (function (d, s, ss, fs) { fs = d.getElementsByTagName(s)[0]; function ce(src) { var cs = d.createElement(s); cs.src = src; setTimeout(function () { fs.parentNode.insertBefore(cs, fs) }, 1); } ce(ss); })(document, 'script', 'https://sc.lfeeder.com/lftracker_v1_lYNOR8xMKOG7WQJZ.js'); })(); </script> <script type="text/javascript"> (function (c, l, a, r, i, t, y) { c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) }; t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i; y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y); })(window, document, "clarity", "script", "4g6s96579b"); </script> <script> function toggleClass() { const mobileMenu = document.querySelector('.mobile_menu-container'); mobileMenu.classList.toggle('toggleMenu'); const hambBcg = document.querySelector('.hamburger'); hambBcg.classList.toggle('hamburger_changeBcg'); } </script></head><body id="contract-testing-with-spring" class="post-layout"><header class="header"><div class="container"><nav class="navbar"> <a href="/" class="logo_wrapper-1920-xx"> <img src="/assets/images/nav/logo-without-blog.svg" alt="logo" /> </a> <a href="/" class="logo_wrapper"> <img src="/assets/images/nav/logo-all.svg" alt="logo" /> </a><ul class="menu"><li><a style="font-weight: bold" href="/category/business">Business</a></li><li><a style="font-weight: bold" href="/category/technical">Technical</a></li><li><a style="font-weight: bold" href="/category/lifestyle">Lifestyle</a></li><li> <a id="homepage_btn" style="background-color: rgb(95, 103, 170);padding: 0 32px; font-weight: bold; color:white" href="https://iterative.engineering" >Go to a main page</a ></li></ul><div onclick="toggleClass()" class="hamburger"> <span class="hamb_bar"></span></div></nav><div class="mobile_menu-container"><ul class="menu_mobile"><li><a href="#">Business</a></li><li><a href="#">Technical</a></li><li><a href="#">Lifestyle</a></li><li> <a style="background-color: rgb(95, 103, 170); color:white" href="https://iterative.engineering">Go to a main page</a></li></ul></div></div></header><main><div class="post"><article itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting"><div class="post__header section-padding--double"><div class="grid-small"><h2 itemprop="name headline">Contract testing with Spring</h2><time class="post__date" datetime="2022-08-08T00:00:00+02:00" itemprop="datePublished">8 Aug 2022</time></div></div><div class="post__img"><div><figure class="absolute-bg" style="background-image: url('/assets/images/contract-testing-with-spring/contract-testing-with-spring.png');"></figure></div></div><div class="post__content section-padding"><div class="grid"><div id="markdown" itemprop="articleBody"><p>Efficient distributed software testing, in particular microservices, is a very challenging subject, yet essential to success. Therefore, as programmers, we often confront a task: how to effectively simulate the behavior of an external service? As we want to quickly receive feedback when changes on either end are causing issues and how they propagate. In this article I present a standardized approach to the problem, a step-by-step guide on how to create effective test infrastructure for your services using Spring Cloud Contract.</p><p><em>If you would like to preview the code used in this article, just clone <a href="https://github.com/IterativeEngineering/blog.consumer-driven-contracts-with-spring">this repository</a>.</em></p><h1 id="contract-testing">Contract Testing</h1><p>So before we jump into code, let’s start with a few definitions. I know, I know, who needs a theory, ey? But I just want to ensure that it’s fully clear what the subject is.</p><p>The Contract is a formal, precise and verifiable interface specification for software components. Similarly, like in business it defines conditions and obligations for participating sides, which typically are available interactions, message structures and communication protocols. The participating sides are in this case software pieces, often referred to as Producer and Consumer.</p><p>As a Producer we can view the Contract as an expectation on what data or actions shall we provide and how. On the other side, Consumers (services that uses the data prepared by Producer) use the Contract to understand how to interact with it and what responses to expect.</p><p>Contract Testing is an approach where Contracts become part of the source code and are used to test it. The goal is to ensure compatibility via fast detection of breaches. As those may occur on either side. Typically the Contract is published as a shareable library, so both Producer and Consumer can rely on it and comply with the agreed structure.</p><p>Contract Tests are not aimed at business features testing or simulate full behavior, they are supposed to only verify the Contract. Thanks to that they allow us to quickly verify the service using stubs without the need to perform time-consuming end-to-end tests, which can be a huge (timewise) win in case of bigger applications.</p><h1 id="spring-cloud-contract">Spring Cloud Contract</h1><p>Ok, so let’s also get a little background about the Spring Cloud Contract project and outline how we will use it.</p><p>As we can read from the <a href="https://spring.io/projects/spring-cloud-contract">documentation</a>, Spring Cloud Contract is an umbrella project holding solutions that help users in successfully implementing the Consumer Driven Contract. In the Spring Cloud Contract nomenclature, we call a pair of such services as the Producer who supplies the service and the Consumer who uses it.</p><p>For the purposes of this article, we will create these services and define a Contract that specifies how they communicate. On the basis of the mentioned Contract, after each change in the application tests and stubs will be regenerated and will guarantee quick feedback if the Contract between the services become broken. When testing microservices, this is a much better approach than creating mocks manually (e.g. using <code class="language-plaintext highlighter-rouge">MockRestServiceServer</code>) because it provides stubs created directly by the service we are calling. This means that they have also been tested on the producer side. What’s more, in Spring Cloud Contract, the creation and release of stubs by the Producer is enforced after every change in service. It means that our stubs are always up to date and we can trust them.</p><h2 id="producer">Producer</h2><p>Now it’s time for practice! Let’s start with the Producer.</p><p><img src="/assets/images/contract-testing-with-spring/producer-side.jpg" alt="Producer side" title="Producer side" /></p><p>Therefore, we will start by creating a simple Spring Boot web application and adding the following dependency:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-contract-verifier<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.1.1.RELEASE<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p>For the sake of simplicity, the Producer will be a service with just one endpoint that sums up 2 provided numbers. So let’s create a controller:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MathController</span> <span class="o">{</span>

  <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/sum"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">sumNumbers</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"argA"</span><span class="o">)</span> <span class="nc">Integer</span> <span class="n">n1</span><span class="o">,</span>
                        <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"argB"</span><span class="o">)</span> <span class="nc">Integer</span> <span class="n">n2</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>Now that we have a working endpoint, let’s create a Contract with a self-descriptive name <code class="language-plaintext highlighter-rouge">shouldReturnSumOfGivenNumbers.groovy</code> (if you prefer the TDD approach, you can first create a contract and generate stubs, and then move on to implementation). To define a contract we call <code class="language-plaintext highlighter-rouge">Contract.make</code> and then:</p><ul><li>Define the consumer’s request details<ul><li>Type of method <code class="language-plaintext highlighter-rouge">GET</code></li><li>Target endpoint <code class="language-plaintext highlighter-rouge">/sum</code></li><li>Query parameters <code class="language-plaintext highlighter-rouge">argA</code> &amp; <code class="language-plaintext highlighter-rouge">argB</code></li></ul></li><li>Define the producer’s expected response with <code class="language-plaintext highlighter-rouge">status 200</code> and body <code class="language-plaintext highlighter-rouge">5</code>.</li></ul><div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">contracts</span>

<span class="kn">import</span> <span class="nn">org.springframework.cloud.contract.spec.Contract</span>

<span class="n">Contract</span><span class="o">.</span><span class="na">make</span> <span class="o">{</span>
  <span class="n">description</span> <span class="s2">"Should return sum of argA and argB"</span>
  <span class="n">request</span> <span class="o">{</span>
    <span class="n">method</span> <span class="nf">GET</span><span class="o">()</span>
    <span class="n">url</span><span class="o">(</span><span class="s2">"/sum"</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">queryParameters</span> <span class="o">{</span>
        <span class="n">parameter</span><span class="o">(</span><span class="s2">"argA"</span><span class="o">,</span> <span class="s2">"2"</span><span class="o">)</span>
        <span class="n">parameter</span><span class="o">(</span><span class="s2">"argB"</span><span class="o">,</span> <span class="s2">"3"</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="n">response</span> <span class="o">{</span>
    <span class="n">body</span><span class="o">(</span><span class="s2">"5"</span><span class="o">)</span>
    <span class="n">status</span> <span class="mi">200</span>
  <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div><p>If you prefer a more declarative style, then it’s also possible to define contracts using yaml files. The contract’s default path is <code class="language-plaintext highlighter-rouge">src/test/resources/contracts</code> but it’s possible to overwrite it by setting <code class="language-plaintext highlighter-rouge">contractsDslDir</code> property in <code class="language-plaintext highlighter-rouge">pom.xml</code> or <code class="language-plaintext highlighter-rouge">build.gradle</code> file.</p><p>Based on the above Contract, we can automatically generate stubs and verification tests during the application building process. For that we use the <em>spring-cloud-contract-maven-plugin</em>:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;plugin&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>spring-cloud-contract-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.1.1.RELEASE<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;extensions&gt;</span>true<span class="nt">&lt;/extensions&gt;</span>
  <span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;baseClassForTests&gt;</span>
      engineering.iterative.producer.setup.ProducerTestSetup
    <span class="nt">&lt;/baseClassForTests&gt;</span>
  <span class="nt">&lt;/configuration&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</code></pre></div></div><p>In section <code class="language-plaintext highlighter-rouge">&lt;baseClassForTests&gt;</code> we provided the path to the configuration class of our tests, which is <code class="language-plaintext highlighter-rouge">ProducerTestSetup</code>. If you prefer you can also use gradle with <em>spring-cloud-contract-gradle-plugin</em>:</p><div class="language-gradle highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">buildscript</span> <span class="o">{</span>
  <span class="k">repositories</span> <span class="o">{</span>
    <span class="n">mavenCentral</span><span class="o">()</span>
  <span class="o">}</span>
  <span class="k">dependencies</span> <span class="o">{</span>
    <span class="n">classpath</span> <span class="s2">"org.springframework.boot:spring-boot-gradle-plugin:${springboot_version}"</span>
    <span class="n">classpath</span> <span class="s2">"org.springframework.cloud:spring-cloud-contract-gradle-plugin:${verifier_version}"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>The ProducerTestSetup looks as follows, note that each generated test will inherit from this class.</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">webEnvironment</span> <span class="o">=</span> <span class="nc">SpringBootTest</span><span class="o">.</span><span class="na">WebEnvironment</span><span class="o">.</span><span class="na">MOCK</span><span class="o">)</span>
<span class="nd">@AutoConfigureMessageVerifier</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProducerTestSetup</span> <span class="o">{</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">MathController</span> <span class="n">mathController</span><span class="o">;</span>

  <span class="nd">@Before</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">StandaloneMockMvcBuilder</span> <span class="n">standaloneMockMvcBuilder</span> <span class="o">=</span>
      <span class="nc">MockMvcBuilders</span><span class="o">.</span><span class="na">standaloneSetup</span><span class="o">(</span><span class="n">mathController</span><span class="o">);</span>
    <span class="nc">RestAssuredMockMvc</span><span class="o">.</span><span class="na">standaloneSetup</span><span class="o">(</span><span class="n">standaloneMockMvcBuilder</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>The <code class="language-plaintext highlighter-rouge">MockMvcBuilders.standaloneSetup()</code> allows the registration of <code class="language-plaintext highlighter-rouge">MathController</code> without the need to use the full web application context. <code class="language-plaintext highlighter-rouge">RestAssuredMockMvc</code> is a REST-assured API built on top of Spring’s MockMvc.</p><p>When we run the build by calling <code class="language-plaintext highlighter-rouge">mvn clean install</code>, the plugin automatically generates a test class in <em>/target/generated-test-sources/contracts/</em> directory:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ContractVerifierTest</span> <span class="kd">extends</span> <span class="nc">ProducerTestSetup</span> <span class="o">{</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate_shouldReturnSumOfGivenNumbers</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

    <span class="c1">// given:</span>
    <span class="nc">MockMvcRequestSpecification</span> <span class="n">request</span> <span class="o">=</span> <span class="n">given</span><span class="o">();</span>

    <span class="c1">// when:</span>
    <span class="nc">ResponseOptions</span> <span class="n">response</span> <span class="o">=</span> <span class="n">given</span><span class="o">().</span><span class="na">spec</span><span class="o">(</span><span class="n">request</span><span class="o">)</span>
          <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">"argA"</span><span class="o">,</span><span class="s">"2"</span><span class="o">)</span>
          <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">"argB"</span><span class="o">,</span><span class="s">"3"</span><span class="o">)</span>
          <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/sum"</span><span class="o">);</span>

    <span class="c1">// then:</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">statusCode</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>

    <span class="c1">// and:</span>
    <span class="nc">DocumentContext</span> <span class="n">parsedJson</span> <span class="o">=</span> <span class="nc">JsonPath</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getBody</span><span class="o">().</span><span class="na">asString</span><span class="o">());</span>
    <span class="nc">String</span> <span class="n">responseBody</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getBody</span><span class="o">().</span><span class="na">asString</span><span class="o">();</span>

    <span class="n">assertThat</span><span class="o">(</span><span class="n">responseBody</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"5"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>That’s it – the Producer setup is done and ready to be used by Consumers.</p><h2 id="consumer">Consumer</h2><p>Since we already have a Producer implementation and defined contract, let’s move on to creating the Consumer service. Our new service will be responsible for calculating the average value of 2 given numbers.</p><p><img src="/assets/images/contract-testing-with-spring/consumer-side.jpg" alt="Consumer side" title="Consumer side" /></p><p>To do this, we first need to use a producer’s endpoint to provide us the sum of the mentioned numbers, and then we can return their average value.</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CalculationController</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RestTemplate</span> <span class="n">restTemplate</span><span class="o">;</span>

  <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/average"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">Double</span> <span class="nf">averageOfTwoDigits</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"argA"</span><span class="o">)</span> <span class="nc">Integer</span> <span class="n">argA</span><span class="o">,</span>
                                   <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"argB"</span><span class="o">)</span> <span class="nc">Integer</span> <span class="n">argB</span><span class="o">)</span> <span class="o">{</span>

    <span class="nc">HttpHeaders</span> <span class="n">httpHeaders</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpHeaders</span><span class="o">();</span>
    <span class="n">httpHeaders</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"Content-Type"</span><span class="o">,</span> <span class="s">"application/json"</span><span class="o">);</span>

    <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">responseEntity</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">exchange</span><span class="o">(</span>
            <span class="s">"http://localhost:8090/sum?argA="</span> <span class="o">+</span> <span class="n">argA</span> <span class="o">+</span> <span class="s">"&amp;argB="</span> <span class="o">+</span> <span class="n">argB</span><span class="o">,</span>
            <span class="nc">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span>
            <span class="k">new</span> <span class="nc">HttpEntity</span><span class="o">&lt;&gt;(</span><span class="n">httpHeaders</span><span class="o">),</span>
            <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kt">double</span> <span class="n">sumResult</span> <span class="o">=</span> <span class="nc">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">responseEntity</span><span class="o">.</span><span class="na">getBody</span><span class="o">()));</span>

    <span class="k">return</span> <span class="n">sumResult</span><span class="o">/</span><span class="mf">2.0</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>We also need to add the <em>spring-cloud-contract-wiremock</em> and <em>spring-cloud-contract-stub-runner</em> dependencies:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>spring-cloud-contract-stub-runner<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.1.1.RELEASE<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>spring-cloud-contract-wiremock<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.1.1.RELEASE<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p>The last step is to create an integration test for the Consumer. This time, we will not mock the behavior of remote service in the test, but we will use generated by the producer stubs. For this purpose, we will use the <code class="language-plaintext highlighter-rouge">@AutoconfigureStubRunner</code> annotation, in which we indicate the artifactId of the jar file that contains our stubs. For this demo project I use <code class="language-plaintext highlighter-rouge">LOCAL</code> stubs mode, but typically <code class="language-plaintext highlighter-rouge">REMOTE</code> is the state we want to reach. You can read more about stubs modes <a href="https://cloud.spring.io/spring-cloud-contract/2.0.x/multi/multi__spring_cloud_contract_stub_runner.html#_stub_downloading">here</a>.</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">webEnvironment</span> <span class="o">=</span> <span class="nc">SpringBootTest</span><span class="o">.</span><span class="na">WebEnvironment</span><span class="o">.</span><span class="na">MOCK</span><span class="o">)</span>
<span class="nd">@AutoConfigureMockMvc</span>
<span class="nd">@AutoConfigureJsonTesters</span>
<span class="nd">@AutoConfigureStubRunner</span><span class="o">(</span>
  <span class="n">stubsMode</span> <span class="o">=</span> <span class="nc">StubRunnerProperties</span><span class="o">.</span><span class="na">StubsMode</span><span class="o">.</span><span class="na">LOCAL</span><span class="o">,</span>
  <span class="n">ids</span> <span class="o">=</span> <span class="s">"engineering.iterative:producer"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">CalculationControllerTest</span> <span class="o">{</span>

  <span class="nd">@Autowired</span> <span class="kd">private</span> <span class="nc">MockMvc</span> <span class="n">mockMvc</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">given_WhenPassEvenNumberInQueryParam_ThenReturnEven</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

    <span class="n">mockMvc</span>
      <span class="o">.</span><span class="na">perform</span><span class="o">(</span>
          <span class="nc">MockMvcRequestBuilders</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/average?argA=2&amp;argB=3"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">))</span>
      <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">())</span>
      <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">content</span><span class="o">().</span><span class="na">string</span><span class="o">(</span><span class="s">"2.5"</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>To create the <code class="language-plaintext highlighter-rouge">CalculationControllerTest</code> we used several Spring annotations like <code class="language-plaintext highlighter-rouge">@RunWith</code>, <code class="language-plaintext highlighter-rouge">@SpringBootTest</code> or <code class="language-plaintext highlighter-rouge">@AutoConfigureMockMvc</code>. If you don’t know them yet, just read <a href="https://www.baeldung.com/spring-boot-testing">this article</a>.</p><p>After running this test, we can see that it uses the generated stubs:</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">WireMock</span><span class="p">:</span> <span class="nx">Admin</span> <span class="nx">request</span> <span class="nx">received</span><span class="p">:</span>
<span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span> <span class="o">-</span> <span class="nx">POST</span> <span class="o">/</span><span class="nx">mappings</span>

<span class="nx">Connection</span><span class="p">:</span> <span class="p">[</span><span class="nx">keep</span><span class="o">-</span><span class="nx">alive</span><span class="p">]</span>
<span class="nx">User</span><span class="o">-</span><span class="nx">Agent</span><span class="p">:</span> <span class="p">[</span><span class="nx">Apache</span><span class="o">-</span><span class="nx">HttpClient</span><span class="o">/</span><span class="mf">4.5</span><span class="p">.</span><span class="mi">5</span> <span class="p">(</span><span class="nx">Java</span><span class="o">/</span><span class="mf">11.0</span><span class="p">.</span><span class="mi">15</span><span class="p">)]</span>
<span class="nx">Host</span><span class="p">:</span> <span class="p">[</span><span class="nx">localhost</span><span class="p">:</span><span class="mi">12003</span><span class="p">]</span>
<span class="nx">Content</span><span class="o">-</span><span class="nx">Length</span><span class="p">:</span> <span class="p">[</span><span class="mi">411</span><span class="p">]</span>
<span class="nx">Content</span><span class="o">-</span><span class="nx">Type</span><span class="p">:</span> <span class="p">[</span><span class="nx">text</span><span class="o">/</span><span class="nx">plain</span><span class="p">;</span> <span class="nx">charset</span><span class="o">=</span><span class="nx">UTF</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
<span class="p">{</span>
  <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">1fbe1b09-2485-4add-a25e-49471f45e665</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">request</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">urlPath</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">/sum</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">method</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">queryParameters</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">argA</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">equalTo</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">2</span><span class="dl">"</span>
      <span class="p">},</span>
      <span class="dl">"</span><span class="s2">argB</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">equalTo</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">3</span><span class="dl">"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="dl">"</span><span class="s2">response</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">status</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">body</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">5</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">transformers</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">response-template</span><span class="dl">"</span> <span class="p">]</span>
  <span class="p">},</span>
  <span class="dl">"</span><span class="s2">uuid</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">1fbe1b09-2485-4add-a25e-49471f45e665</span><span class="dl">"</span>
<span class="p">}</span>

<span class="nx">o</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">c</span><span class="p">.</span><span class="nx">c</span><span class="p">.</span><span class="nx">stubrunner</span><span class="p">.</span><span class="nx">StubRunnerExecutor</span>    <span class="p">:</span> <span class="nx">All</span> <span class="nx">stubs</span> <span class="nx">are</span> <span class="nx">now</span> <span class="nx">running</span> <span class="nx">RunningStubs</span>
   <span class="p">[</span><span class="nx">namesAndPorts</span><span class="o">=</span><span class="p">{</span><span class="nx">engineering</span><span class="p">.</span><span class="na">iterative</span><span class="p">:</span><span class="na">producer</span><span class="p">:</span><span class="mf">0.0</span><span class="p">.</span><span class="mi">1</span><span class="o">-</span><span class="na">SNAPSHOT</span><span class="p">:</span><span class="nx">stubs</span><span class="o">=</span><span class="mi">12003</span><span class="p">}]</span>
</code></pre></div></div><p>Now, when we change something on the Producer’s side, we also have to change the Contract. After it is pushed to the common repository (in our example – local repository), the Consumer’s tests will stop passing due to the fact that it does not meet the new conditions of the contract.</p><h1 id="conclusions">Conclusions</h1><p>Spring Cloud Contract allows to easily implement a contract driven approach, which provides autocontrol over API changes. It is especially useful when dealing with microservices architecture, benefiting with:</p><ul><li>Quick feedback, on both ends, if breaking changes are applied to a Contract</li><li>No need to mock the behavior of remote services in consumer’s tests</li><li>Formalizing the way and place that Contracts are defined. All you need to do is to define a contract and release mocks so that other teams can start working on their services before we even start implementing the producer’s logic.</li><li>In setups where given service is used by many other services Stubs are always up to date (new stubs release is enforced after every change in Producer side)</li></ul><p>If you found this article interesting check out official <a href="https://spring.io/projects/spring-cloud-contract">documentation</a>, take a look at <a href="https://www.youtube.com/watch?v=IiK9A9nQ6NU">videos</a> by Spring Cloud Contract authors or <a href="https://calendly.com/krzysztof-gasior">talk to us</a>.</p><h2 id="references">References</h2><ul><li><p><a href="https://www.baeldung.com/spring-cloud-contract">https://www.baeldung.com/spring-cloud-contract</a></p></li><li><p><a href="https://spring.io/projects/spring-cloud-contract">https://spring.io/projects/spring-cloud-contract</a></p></li><li><p><a href="https://www.youtube.com/watch?v=IiK9A9nQ6NU">https://www.youtube.com/watch?v=IiK9A9nQ6NU</a></p></li><li><p><a href="https://www.schibsted.pl/blog/contract-testing/">https://www.schibsted.pl/blog/contract-testing/</a></p></li><li><p><a href="https://cloud.spring.io/spring-cloud-contract/reference/html/getting-started.html">https://cloud.spring.io/spring-cloud-contract/reference/html/getting-started.html</a></p></li></ul></div><ul class="post__social"><li><a href="https://www.facebook.com/sharer/sharer.php?u=https://blog.iterative.engineering/2022/08/08/contract-testing-with-spring/" target="_blank"><i class="fa fa-facebook"></i></a></li><li><a href="https://twitter.com/intent/tweet?&text=Contract testing with Spring+https://blog.iterative.engineering/2022/08/08/contract-testing-with-spring/+by+Paweł NowosielskiKrzysztof Gąsior" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?mini=true&source=Contract testing with Spring&summary=A step-by-step guide on how to create effective test infrastructure for your services using Spring Cloud Contract.&url=https://blog.iterative.engineering/2022/08/08/contract-testing-with-spring/" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="https://www.reddit.com/submit?url=https://blog.iterative.engineering/2022/08/08/contract-testing-with-spring/" target="_blank"><i class="fa fa-reddit-alien"></i></a></li></ul></div></div><div class="section-padding--none"><div class="grid"><hr class="sep"/></div></div><div class="section-padding"><div class="grid-small"> Posted by<div class="post__author"> <img src="/assets/images/team/pn.png" alt="Paweł Nowosielski from Iterative Engineering"> <span> Paweł Nowosielski<p class="post__bio">Software Engineer @ Iterative Engineering</p></span></div><div class="post__author"> <img src="/assets/images/team/kg.png" alt="Krzysztof Gąsior from Iterative Engineering"> <span> <a href="https://www.linkedin.com/in/krzysztof-gasior/" title="Krzysztof Gąsior"> Krzysztof Gąsior</a><p class="post__bio">CEO @ Iterative Engineering</p></span></div></div></div></article></div><section class="related section-padding"><div class="grid-xlarge"><h2 class="related__title">Related</h2><div class="related__container"><article class="related__post"> <a class="related__link" href="https://blog.iterative.engineering/2022/08/08/contract-testing-with-spring/"><figure class="related__img"> <img src="/assets/images/contract-testing-with-spring/contract-testing-with-spring.png" alt="Contract testing with Spring"/></figure><div><h2 class="related__text">Contract testing with Spring</h2></div></a></article><article class="related__post"> <a class="related__link" href="https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/"><figure class="related__img"> <img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/spring-and-ms-azure-ad.png" alt="Secure Spring Boot Application with Microsoft Azure AD"/></figure><div><h2 class="related__text">Secure Spring Boot Application with Microsoft Azure AD</h2></div></a></article></div></div></section></main><div class="cookies"><div class="cookies-text"> This site uses "cookie" files, You can find more information here: <a href="cookies-policy.html" target="_blank" rel="noopener noreferrer nofollow" > cookies policy</a >. If you do not agree to store information in cookies, please change your browser settings.</div><div class="confirm-cookies" aria-hidden="true">I understand and accept</div></div><footer class="footer_container"><div class="main_content-wrapper"><div class="main_content"><div class="column-left"><div class="headquarter"><h4 class="headers">HEADQUARTERS</h4><div class="address text_line-spacing"> <img class="column_left-icon" src="/assets/images/icons/location-pin-icon.svg" alt="location" /><div class="location"> <span>&nbsp;ul. Wolności 191/311</span> <span>&nbsp;41-800 Zabrze, Silesia,</span> <span>&nbsp;Poland</span></div></div><div class="text_line-spacing"> <img class="column_left-icon" src="/assets/images/icons/mail-icon.svg" alt="email" /> <a class="text-hover" href="mailto:contact@iterative.pl" >office@iterative.pl</a ></div></div><div class="business-development"><h4 class="headers">BUSINESS DEVELOPMENT</h4><div class="text_line-spacing"> <img class="column_left-icon" src="/assets/images/icons/person-icon.svg" alt="email" /> <span>Krzysztof Gąsior</span></div><div> <img class="column_left-icon" src="/assets/images/icons/phone-icon.svg" alt="email" /> <a class="text_line-spacing text-hover" href="tel:+48 793 901 086" >+48 793 901 086</a ></div><div class="contact-meeting"> <img class="column_left-icon" src="/assets/images/icons/mail-icon.svg" alt="email" /> <a class="text_line-spacing text-hover" href="mailto:krzysztof.gasior@iterative.pl" >krzysztof.gasior@iterative.pl</a > <a class="link_schedule-meeting" href="https://calendly.com/krzysztof-gasior/" target="_blank" > <button class="schedule-meeting">Schedule a meeting</button> </a></div></div><div class="clutch-widget" data-url="https://widget.clutch.co" data-widget-type="2" data-height="45" data-theme="white" data-clutchcompany-id="746552" ></div></div><div class="separator"></div><div class="right-column"><div class="find-out"><h4 class="headers">FIND OUT WHAT WE WRITE ABOUT</h4><a class="text_line-spacing text-hover" href="/2022/08/08/contract-testing-with-spring/" >Contract testing with Spring</a ><br /> <a class="text_line-spacing text-hover" href="/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/" >Secure Spring Boot Application with Microsoft Azure AD</a ><br /> <a class="text_line-spacing text-hover" href="/2021/12/20/how-to-keep-the-team-integrated/" >How to keep the team integrated despite physical distance</a ><br /> <a class="text_line-spacing text-hover" href="/2021/12/10/key-8-takeaways-from-stackoverflow-2021-developers-survey/" >Key 8 Takeaways from Stack Overflow 2021 Developers Survey</a ><br /> <a class="text_line-spacing text-hover" href="/2021/09/28/creating-optimised-docker-images-using-multi-stage-builds/" >Creating optimised Docker Images using Multi-Stage Builds</a ><br /> <a class="text_line-spacing text-hover" href="/category/business/" >more...</a ></div><div class="discover-offer"><h4 class="headers">DISCOVER OUR OFFER</h4><a class="text_line-spacing text-hover" href="https://iterative.engineering/software-development-for-london-based-companies" >Software Development for London Based Companies</a ><br /> <a class="text_line-spacing text-hover" href="https://iterative.engineering/software-development-for-aberdeen-based-companies" >Software Development for Aberdeen Based Companies</a ><br /> <a class="text_line-spacing text-hover" href="https://iterative.engineering/digital-product-development-for-fintech" >Digital Product Development for Fintech</a ></div><div class="menu_footer"><h4 class="headers">Menu</h4><a class="text_line-spacing text-hover" href="/">Home</a><br /> <a class="text_line-spacing text-hover" href="/">About us</a><br /> <a class="text_line-spacing text-hover" href="/">Services</a><br /> <a class="text_line-spacing text-hover" href="/">Blog</a></div></div></div></div><div class="bottom_bar-container"><div class="bottom_bar-policy-social"><div class="bottom_bar-policy-info"><div class="company-info"><div class="bottom_bar-copyrights"> <img class="bottom_bar-copyright-icon" src="/assets/images/icons/copyright.svg" /> <span class="bottom_bar-text bottom_bar-rights_text"> 2023 Iterative Engineering Sp. z o.o. - All rights reserved </span></div><span class="bottom_bar-text" >VAT-EU: PL6482804153 | REGON: 388898977 | KRS: 0000900004 </span></div><div class="policy_container"> <a class="bottom_bar-text" href="cookies-policy.html" target="_blank" rel="noopener noreferrer nofollow" >Cookies policy</a > <a class="bottom_bar-text" href="privacy-policy.html" target="_blank" rel="noopener noreferrer nofollow" >Privacy policy</a ></div></div><div class="bottom_bar-social-icons"> <a href="https://clutch.co/profile/iterative-engineering#summary" target="_blank" rel="noopener noreferrer nofollow" > <img class="social-icons" src="/assets/images/icons/clutch-icon.svg" alt="clutch profile" /> </a> <a href="https://github.com/IterativeEngineering" target="_blank" rel="noopener noreferrer nofollow" > <img class="social-icons" src="/assets/images/icons/github-icon.svg" alt="github profile" /> </a> <a href="https://www.facebook.com/IterativeEngineering/" target="_blank" rel="noopener noreferrer nofollow" > <img class="social-icons" src="/assets/images/icons/fb-icon.svg" alt="facebook profile" /> </a> <a href="https://linkedin.com/company/11263564/" target="_blank" rel="noopener noreferrer nofollow" > <img class="social-icons" src="/assets/images/icons/linkedin-icon.svg" alt="linkedin profile" /> </a></div></div></div></footer><script src="/assets/js/app.min.js?14596efc646507d9d188130d517c746d"></script></body></html>
  