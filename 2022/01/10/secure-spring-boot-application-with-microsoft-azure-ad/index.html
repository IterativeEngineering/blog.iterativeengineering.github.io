<!DOCTYPE html><html lang="en"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Secure Spring Boot Application with Microsoft Azure AD</title><meta property="og:title" content="Secure Spring Boot Application with Microsoft Azure AD"><meta property="og:site_name" content="Iterative Engineering Blog"><meta name="author" content="Iterative Engineering Team"><meta property="og:locale" content="en_GB"><meta property="og:description" content="Walkthrough on how to setup OAuth in a Java Spring based app using Microsoft Azure AD as a Identity Provider."><meta property="description" content="Walkthrough on how to setup OAuth in a Java Spring based app using Microsoft Azure AD as a Identity Provider."><meta property="og:url" content="https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/"><meta property="og:image" content="https://blog.iterative.engineering/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/spring-and-ms-azure-ad.png"><meta name="twitter:url" content="https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Secure Spring Boot Application with Microsoft Azure AD | Iterative Engineering Blog"><meta name="twitter:site" content="Iterative Engineering Blog"><meta name="twitter:description" content="Walkthrough on how to setup OAuth in a Java Spring based app using Microsoft Azure AD as a Identity Provider."><link rel="canonical" href="https://iterative.engineering"><link rel="shortcut icon" href="/assets/images/favicon.png"/><link rel="stylesheet" href="/assets/css/app.min.css?000e6330514fc297bbe6704a9ea0e57c"><link rel="alternate" type="application/rss+xml" title="Iterative Engineering Blog" href="/feed.xml"><link rel="canonical" href="/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/"> <script defer type="text/javascript" src="https://widget.clutch.co/static/js/widget.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-68442502-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-68442502-1'); </script> <script> (function () { window.ldfdr = window.ldfdr || {}; (function (d, s, ss, fs) { fs = d.getElementsByTagName(s)[0]; function ce(src) { var cs = d.createElement(s); cs.src = src; setTimeout(function () { fs.parentNode.insertBefore(cs, fs) }, 1); } ce(ss); })(document, 'script', 'https://sc.lfeeder.com/lftracker_v1_lYNOR8xMKOG7WQJZ.js'); })(); </script> <script type="text/javascript"> (function (c, l, a, r, i, t, y) { c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) }; t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i; y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y); })(window, document, "clarity", "script", "4g6s96579b"); </script></head><body id="secure-spring-boot-application-with-microsoft-azure-ad" class="post-layout"><header class="header"><div class="header-navigation"><div class="header-navigation-wrapper"><div class="logo"> <a class="logo-hyperlink" aria-current="page" href="https://iterative.engineering"> <svg width="227" height="40" viewBox="0 0 227 40" fill="none" xmlns="http://www.w3.org/2000/svg"> <g id="logo"><path fill-rule="evenodd" clip-rule="evenodd" d="M0 0.240014C0 0.107546 0.107546 0 0.240014 0H4.55932C4.69179 0 4.79933 0.107546 4.79933 0.240014V4.55932C4.79933 4.69179 4.69179 4.79934 4.55932 4.79934H0.240014C0.107546 4.79934 0 4.69179 0 4.55932V0.240014H0Z" fill="#323232" /><path fill-rule="evenodd" clip-rule="evenodd" d="M0 21.6052C0 21.4728 0.107546 21.3652 0.240014 21.3652H4.55932C4.69179 21.3652 4.79933 21.4728 4.79933 21.6052V39.7599C4.79933 39.8924 4.69179 39.9999 4.55932 39.9999H0.240014C0.107546 39.9999 0 39.8924 0 39.7599V21.6052H0Z" fill="#323232" /><path d="M40.0017 0H27.9883V3.60401H40.0017V0Z" fill="#323232" /><path fill-rule="evenodd" clip-rule="evenodd" d="M36.3984 0V12.0134H40.0026V0H36.3984Z" fill="#323232" /><path d="M40.0017 0H27.9883V3.60401H40.0017V0Z" fill="#323232" /><path fill-rule="evenodd" clip-rule="evenodd" d="M36.3984 0V12.0134H40.0026V0H36.3984Z" fill="#323232" /><path d="M27.871 12.1307H0V15.7347H27.871V12.1307Z" fill="url(#paint1_linear)" /><path fill-rule="evenodd" clip-rule="evenodd" d="M15.7412 27.8617V0H12.1371V27.8617H15.7412Z" fill="url(#paint2_linear)" /><path d="M27.871 12.1307H0V15.7347H27.871V12.1307Z" fill="url(#paint3_linear)" /><path fill-rule="evenodd" clip-rule="evenodd" d="M27.8792 39.9949V12.1239H24.2751V39.9949H27.8792Z" fill="url(#paint4_linear)" /><path d="M40.0091 24.2545H12.1381V27.8585H40.0091V24.2545Z" fill="url(#paint5_linear)" /><path fill-rule="evenodd" clip-rule="evenodd" d="M15.7412 27.8617V0H12.1371V27.8617H15.7412Z" fill="url(#paint0_linear)" /> </g> <g id="iterative"><path d="M59.7748 10.4123H55.8796V24.0105H59.7748V10.4123Z" fill="#323232" /><path d="M59.7748 0H55.8796V3.89562H59.7748V0Z" fill="#323232" /><path d="M88.3015 24.0178H104.938V20.9293H92.1967V3.08849H104.938V0H88.3015V24.0178Z" fill="#323232" /><path d="M139.261 0L130.561 24.0175H134.455L136.349 18.6409L137.442 15.5516L141.773 3.30642L146.105 15.5516H140.361L139.271 18.6409H147.161L149.054 24.0175H152.986L144.248 0H139.261Z" fill="#323232" /><path d="M88.3015 24.0178H104.938V20.9293H92.1967V3.08849H104.938V0H88.3015V24.0178Z" fill="#323232" /><path d="M108.032 0V24.0175H111.928V3.0893H120.154C121.283 3.0893 122.084 3.48792 122.084 4.65061V10.6466C122.084 11.8093 121.283 12.2093 120.154 12.2093H115.822V15.2972H119.171L123.248 24.0175H127.472L122.811 14.9708C124.268 14.6801 125.979 13.3358 125.979 10.6106V5.95877C125.979 1.12612 123.904 0 118.444 0H108.032V0Z" fill="#323232" /><path d="M95.118 10.4748V13.5641H101.042V10.4748H95.118Z" fill="#323232" /><path d="M121.798 12.2068H114.849V15.2949H121.798V12.2068Z" fill="#323232" /><path d="M72.0911 0V24.0187H75.9859V3.08916H85.3007V0H72.0911V0Z" fill="#323232" /><path d="M75.9897 0V24.0187H72.0949V3.08916H62.78V0H75.9897V0Z" fill="#323232" /><path d="M182.397 0.796875H178.502V24.005H182.397V0.796875Z" fill="#323232" /><path d="M182.398 0H178.502V3.89562H182.398V0Z" fill="#323232" /><path d="M193.822 24.0178H198.809L207.182 0H203.25L196.334 20.7113L189.381 0H185.485L193.822 24.0178Z" fill="#323232" /><path d="M210.273 24.0178H226.91V20.9293H214.168V3.08849H226.91V0H210.273V24.0178Z" fill="#323232" /><path d="M217.09 10.4609V13.5501H223.015V10.4609H217.09Z" fill="#323232" /><path d="M162.291 0V24.0187H166.186V3.08916H175.501V0H162.291V0Z" fill="#323232" /><path d="M166.19 0V24.0187H162.295V3.08916H152.98V0H166.19V0Z" fill="#323232" /> </g><path d="M226.915 27.5242H55.8796V28.3242H226.915V27.5242Z" fill="#323232" /> <g id="engineering"><path d="M55.8518 39.9927H61.5661V38.9666H57.1898V36.3713H61.191V35.3452H57.1898V33.0395H61.5661V32.0135H55.8518V39.9927Z" fill="#323232" /><path d="M72.4921 39.9927H73.83V32.9068L77.6562 39.9927H79.8944V32.0135H78.5565V39.0995L74.7053 32.0135H72.4921V39.9927Z" fill="#323232" /><path d="M92.1613 38.2062V33.8C92.1613 33.2569 92.3238 33.0395 92.8239 33.0395H97.3753V32.0135H93.1866C91.7236 32.0135 90.8233 32.7377 90.8233 34.0657V37.9406C90.8233 39.2684 91.7236 39.9927 93.1866 39.9927H97.3753V35.7556H96.0374V38.9666H92.8239C92.3238 38.9666 92.1613 38.7493 92.1613 38.2062Z" fill="#323232" /><path d="M109.634 32.0135H108.296V39.9927H109.634V32.0135Z" fill="#323232" /><path d="M120.558 39.9927H121.896V32.9068L125.722 39.9927H127.96V32.0135H126.622V39.0995L122.771 32.0135H120.558V39.9927Z" fill="#323232" /><path d="M138.889 39.9927H144.603V38.9666H140.226V36.3713H144.228V35.3452H140.226V33.0395H144.603V32.0135H138.889V39.9927Z" fill="#323232" /><path d="M155.529 39.9927H161.243V38.9666H156.867V36.3713H160.868V35.3452H156.867V33.0395H161.243V32.0135H155.529V39.9927Z" fill="#323232" /><path d="M177.246 36.9869C177.747 36.8903 178.334 36.4437 178.334 35.5384V33.9932C178.334 32.3877 177.621 32.0135 175.746 32.0135H172.17V39.9927H173.508V37.0955H175.996L177.396 39.9927H178.847L177.246 36.9869ZM173.508 33.0395H176.334C176.721 33.0395 176.996 33.1724 176.996 33.5587V35.5504C176.996 35.9367 176.721 36.0695 176.334 36.0695H173.508V33.0395Z" fill="#323232" /><path d="M191.105 32.0135H189.767V39.9927H191.105V32.0135Z" fill="#323232" /><path d="M202.029 39.9927H203.367V32.9068L207.193 39.9927H209.431V32.0135H208.093V39.0995L204.242 32.0135H202.029V39.9927Z" fill="#323232" /><path d="M221.698 38.2062V33.8C221.698 33.2569 221.86 33.0395 222.36 33.0395H226.912V32.0135H222.723C221.26 32.0135 220.36 32.7377 220.36 34.0657V37.9406C220.36 39.2684 221.26 39.9927 222.723 39.9927H226.912V35.7556H225.574V38.9666H222.36C221.86 38.9666 221.698 38.7493 221.698 38.2062Z" fill="#323232" /> </g> <defs><linearGradient id="paint0_linear" x1="12.017" y1="12.1288" x2="27.8746" y2="27.9812" gradientUnits="userSpaceOnUse"> <stop stop-color="#5761B2" /> <stop offset="1" stop-color="#1FC5A8" /> </linearGradient><linearGradient id="paint1_linear" x1="12.0134" y1="12.1307" x2="27.8709" y2="27.983" gradientUnits="userSpaceOnUse"> <stop stop-color="#5761B2" /> <stop offset="1" stop-color="#1FC5A8" /> </linearGradient><linearGradient id="paint2_linear" x1="12.017" y1="12.1288" x2="27.8746" y2="27.9812" gradientUnits="userSpaceOnUse"> <stop stop-color="#5761B2" /> <stop offset="1" stop-color="#1FC5A8" /> </linearGradient><linearGradient id="paint3_linear" x1="12.0134" y1="12.1307" x2="27.8709" y2="27.983" gradientUnits="userSpaceOnUse"> <stop stop-color="#5761B2" /> <stop offset="1" stop-color="#1FC5A8" /> </linearGradient><linearGradient id="paint4_linear" x1="12.0215" y1="12.1292" x2="27.8791" y2="27.9815" gradientUnits="userSpaceOnUse"> <stop stop-color="#5761B2" /> <stop offset="1" stop-color="#1FC5A8" /> </linearGradient><linearGradient id="paint5_linear" x1="12.018" y1="12.1264" x2="27.8755" y2="27.9787" gradientUnits="userSpaceOnUse"> <stop stop-color="#5761B2" /> <stop offset="1" stop-color="#1FC5A8" /> </linearGradient> </defs> </svg> </a></div><div class="menu-wrapper"><div class="menu-items"><nav class="menu"><div class="item"> <a href="https://iterative.engineering"> HOME </a></div><div class="item"> <a href="/" class="active"> BLOG </a></div><div class="schedule-meeting-button"> <a href="https://calendly.com/krzysztof-gasior" target="_blank">SCHEDULE A MEETING!</a></div></nav></div></div></div></div></header><main><div class="post"><article itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting"><div class="post__header section-padding--double"><div class="grid-small"><h2 itemprop="name headline">Secure Spring Boot Application with Microsoft Azure AD</h2><time class="post__date" datetime="2022-01-10T00:00:00+01:00" itemprop="datePublished">10 Jan 2022</time></div></div><div class="post__img"><div><figure class="absolute-bg" style="background-image: url('/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/spring-and-ms-azure-ad.png');"></figure></div></div><div class="post__content section-padding"><div class="grid"><div id="markdown" itemprop="articleBody"><p>Application security is an important part of cohesive digital product security and one for which typically software developers are responsible for. Handling it properly and according to industry standards is crucial, especially nowadays where literally anything that gets published is immediately targeted and scanned for vulnerabilities.</p><p>One of the most common challenges in that aspect is authentication &amp; authorization of the users. While there are many ways to do it, its really worth considering an external Identity Provider approach either via OAuth2 or SAML. The reason is that it typically gives great and proven security without the need to code and maintain the whole process, which is not trival!</p><p>This article presents an in detail walkthrough on how to secure a Java Spring Boot Application using Microsoft Azure AD, which is a great and widely adopted example of a reliable Identity Provider.</p><h4 id="who-may-find-this-article-helpful">Who may find this article helpful</h4><ul><li>Java developers experienced with Spring looking for ‘how to’ on pluging in Azure AD as Identity Provider into their apps.</li><li>Software Developers wishing to increase their knowledge around applications security and authentication schemes.</li></ul><p>If you belong to first group you may skip the first part and jump directly to the “Register application in Azure Tenant” chapter.</p><h4 id="what-will-you-learn">What will you learn</h4><ul><li>What are the advantages and disadvantages of using an external Identity Provider</li><li>How to configure and register your application in the Azure Tenant which is required to secure it by Azure AD</li><li>How to configure Spring Boot Application to secure it via Microsoft Identity Provider</li><li>How to configure Nginx / Apache as a reverse proxy when secured as such</li></ul><h4 id="example-project">Example project</h4><p>One to be found on GitHub: <a href="https://github.com/IterativeEngineering/blog.secure-spring-boot-application-with-microsoft-azure-ad">Spring Boot Secured App</a></p><h4 id="prerequisites">Prerequisites</h4><ul><li>Azure account with a subscription (e.g Pay as you go)</li><li>Java 11 or higher (or a docker container with such)</li></ul><h1 id="self-implemented-authentication--authorization">Self-implemented Authentication &amp; Authorization</h1><p>Imagine that in 2010 you have to prepare an application for e.g company managers. With different access levels. What would be your approach to achieve that? Most probably you would go with something similar to:</p><ol><li>Create a table of users + passwords and roles in the application</li><li>Prepare admin panel that allows to manage users and their privileges</li><li>Manage sessions (either as cookies or tokens) on the client web-app side and store them on the application server, e.g in memory or in DB</li><li>Implement features such as: Password restore</li></ol><p>A self baked authentication &amp; authorization system with local user information storage. Such setup, even today, is a common way to craft a prototype or MVP and it has advantages:</p><ul><li>low complexity - no 3rd party libraries, no external services engaged</li><li>data control - all users data are available and may be used the application</li></ul><p>However, it has also major disadvantages:</p><ul><li>vulnerability - Important user data are stored within the application. So they have to be well secured</li><li>maintenance problems - Roles/groups have to be managed in the app, not in a central point</li><li>limited extendability - Each feature such as 2FA, Single Sign-On have to be implemented, while implementing security mechanisms is costly and time consuming</li><li>lack of 3rd party systems integrations - For instance logging via Facebook or Google have to be implemented within the application. While services like Azure AD provide easy-to-use integrations.</li></ul><p>In the long term maintenance efforts could be significant, while not giving any benefits. So let’s look at alternatives.</p><h2 id="identity-providers-come-on-stage">Identity providers come on stage</h2><p>In 2007 OAuth 1.0 protocol was released and in 2012 its new version: Oauth 2.0 was released. This started a popularization process of external identity providers - systems that keep users data and provide these data to business applications with user acceptance.</p><p>OAuth 2.0 is widely supported by Microsoft, Google, Amazon etc. The solution I present in this article, while aimed at Microsoft Azure, could be implemented with other identity providers with minor tweaks.</p><h1 id="how-to-secure-spring-boot-with-azure-ad">How to secure Spring Boot with Azure AD</h1><p>Let’s go step by step through the configurations that have to be applied in the Microsoft Azure Portal, to secure the application using the Azure Active Directory.</p><ul><li>Register application in Microsoft Azure Tenant</li><li>Create &amp; Configure Java (Spring Boot) Application</li><li>Configure reverse proxy</li><li>Authenticate to the app (Test the setup)</li></ul><h2 id="register-application-in-azure-tenant">Register application in Azure Tenant</h2><p>Here are steps that are presented below on screenshots:</p><ul><li>Create a new Tenant</li><li>Register a new application &amp; set its allowed ‘redirect-uri’</li><li>Generate application secret</li></ul><h3 id="setup-a-new-tenant">Setup a new Tenant</h3><ol><li><p>Log in to portal.azure.com and search for Azure Active Directory service:</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/9.png" alt="Search for Azure Active Directory" title="Search for Azure Active Directory" />  </p></li><li><p>Select manage tenants:</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/15.png" alt="Select manage tenants" title="Select manage tenants" />  </p></li><li><p>Select basic tenant:</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/14.png" alt="Select basic tenant" title="Select basic tenant" />  </p></li><li><p>Finish the configuration and create it:</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/12.png" alt="Finish the configuration and create it" title="Finish the configuration and create it" />  </p></li><li><p>Once ready copy the tenant ID, as it will be neccessary further:</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/11.png" alt="Once ready copy the tenant ID" title="Once ready copy the tenant ID" /></p></li></ol><h3 id="register-a-new-application--set-its-allowed-redirect-uri">Register a new application &amp; set its allowed ‘redirect-uri’</h3><ol><li><p>Select “App registrations” and “Register an application”</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/3.png" alt="Register a new application via App registration" title="Register a new application via App registration" />  </p></li><li><p>Define app name and set redirect URI:</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/2.png" alt="Define app name and redirect URI" title="Define app name and redirect URI" /></p></li></ol><ul><li><strong>Name:</strong> Users will see this name e.g on the “Grant permissions” screen.</li><li><strong>Supported accounts types:</strong> By choosing option 1 only you and users from your tenant will be able to log in to the application. As you see, you can allow logging in to your application even for users who are not part of your organisation (option 2,3,4). Choose these options wisely, and only if your application does not expose any vulnerable data.</li><li><strong>Redirect URI:</strong> In our example it’s not optional. It’s the URL to which the user is redirected after a successful authentication on the Microsoft login page. If you deploy your application not on localhost but on some server, change localhost:8080 to the appropriate domain name.</li></ul><h3 id="create-a-secret">Create a Secret</h3><ol><li><p>Generate a new client secret <img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/10.png" alt="Add certificate or secret" title="Add certificate or secret" /></p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/4.png" alt="Create new client secret" title="Create new client secret" /></p><p>Note: All secrets have to have an expiration date and they can’t be renewed, so if a secret expires, you can generate a new secret and update it in your application.</p></li><li><p>Copy and save the Secret value (it is visible only just after secret creation)</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/16.png" alt="Copy and save generated Secret" title="Copy and save generated Secret" /></p></li></ol><p><strong>Never reveal the Secret to anyone nor publish it to public repositories!</strong></p><p>Great! At this point the setup on the Azure side is now complete, let’s move on to the application.</p><h2 id="configure-spring-boot-application">Configure Spring-Boot application</h2><p>Key things that have to be created:</p><ul><li>Dependency to the azure spring-boot library that does the ‘magic’ and simplifies integration between SpringBoot app and our Azure Tenant</li><li>Properties that allow the app to connect to the Azure Tenant</li><li>Rest controller that will be used for tests</li></ul><p>Here is an example build.gradle file, but a similar setup could be done in maven pom.xml.</p><p><em>build.gradle</em></p><div class="language-gradle highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plugins</span> <span class="o">{</span>
  <span class="n">id</span> <span class="s2">"org.springframework.boot"</span> <span class="n">version</span> <span class="s2">"2.5.0"</span>
  <span class="n">id</span> <span class="s1">'io.spring.dependency-management'</span> <span class="n">version</span> <span class="s1">'1.0.6.RELEASE'</span>
  <span class="n">id</span> <span class="s1">'java'</span>
<span class="o">}</span>

<span class="n">group</span> <span class="o">=</span> <span class="s1">'pl.iterative'</span>

<span class="n">version</span> <span class="o">=</span> <span class="s1">'1.0.0-SNAPSHOT'</span>

<span class="k">repositories</span> <span class="o">{</span>
  <span class="n">mavenLocal</span><span class="o">()</span>
  <span class="n">mavenCentral</span><span class="o">()</span>
  <span class="n">gradlePluginPortal</span><span class="o">()</span>
<span class="o">}</span>

<span class="k">dependencies</span> <span class="o">{</span>

  <span class="c1">// Spring boot</span>
  <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-oauth2-client'</span>
  <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-web'</span>

  <span class="c1">// Azure</span>
  <span class="n">implementation</span> <span class="s1">'com.azure.spring:azure-spring-boot-starter-active-directory:3.5.0'</span>

<span class="o">}</span>
</code></pre></div></div><p><em>application.properties</em></p><div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">server.port</span> <span class="p">=</span> <span class="s">8080</span>
<span class="py">azure.activedirectory.tenant-id</span> <span class="p">=</span> <span class="s">e76d7581-eabe-4e6b-a676-55e28d9325ee</span>
<span class="py">azure.activedirectory.client-id</span> <span class="p">=</span> <span class="s">4b37344a-6dda-4e10-9f02-359477227f25</span>
<span class="py">azure.activedirectory.client-secret</span> <span class="p">=</span> <span class="s">SECRET_VALUE_HERE</span>
</code></pre></div></div><p><em>Application.java</em></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">pl.iterative</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Application</span> <span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">Application</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
 <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p><em>AuthController.java</em></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">pl.iterative.api</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/api"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthController</span> <span class="o">{</span>
 <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
 <span class="kd">public</span> <span class="nc">String</span> <span class="nf">login</span><span class="o">()</span> <span class="o">{</span>
   <span class="k">return</span> <span class="s">"User logged in"</span><span class="o">;</span>
 <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>The default setup restricts access to all application endpoints. If you wish to customize following article describes how to implement custom security configuration: <a href="https://www.baeldung.com/java-config-spring-security#Security">https://www.baeldung.com/java-config-spring-security#Security</a></p><p>For the sake of this tutorial we will stick to defaults. Once the app is prepared as above config we can run it and access the resource: <a href="http://localhost:8080/api/v1/login">http://localhost:8080/api/login</a> via a web browser.</p><p>On the first login attempt, the user is asked to consent to grant the permissions that the application requests. Always grant this consent carefully, especially to applications you don’t develop, and check precisely which exact permissions you’re granting.</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/13.png" alt="Microsoft Azure permission request for identity data" title="Microsoft Azure permission request for identity data" /></p><p>A successful log-in process is finished, when user accesses the requested resource:</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/17.png" alt="URL if login is successfuly" title="URL if login is successfuly" /></p><p>What actually happens during the authorization process is described further in the article.</p><h2 id="configure-nginx--apache-reverse-proxy">Configure Nginx / Apache reverse proxy</h2><p>So while we got the Spring App and Azure AD to work together it’s common scenario to put app behind a reverse proxy like Nginx or Apache.</p><p>However such case implies requirement for additional set up, as we need to properly handle headers and redirects on proxy side.</p><h3 id="app-config">App config</h3><p>Add following entries to the application.properties, as first we need to let know app that its behind the proxy.</p><p><em>application.properties</em></p><div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">server.forward-headers-strategy</span> <span class="p">=</span> <span class="s">FRAMEWORK</span>
<span class="py">server.tomcat.redirect-context-root</span> <span class="p">=</span> <span class="s">false</span>
</code></pre></div></div><h3 id="nginx">Nginx</h3><p>If using Nginx as a proxy, we nned to set proxy_set_header directives and a proxy rule for <code class="highlighter-rouge">/oauth2</code> endpoint, so roughly like following, assuming the app is accessible on localhost under port 8080:</p><div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
  <span class="kn">proxy_set_header</span>     <span class="s">X-Forwarded-Proto</span>   <span class="nv">$scheme</span><span class="p">;</span>
  <span class="kn">location</span> <span class="n">/oauth2</span> <span class="p">{</span>
    <span class="kn">proxy_pass</span> <span class="s">http://localhost:8080/oauth2</span><span class="p">;</span>
  <span class="p">}</span> 
  <span class="kn">location</span> <span class="n">/login/oauth2</span> <span class="p">{</span>
    <span class="kn">proxy_pass</span> <span class="s">http://localhost:8080/login/oauth2</span><span class="p">;</span>
  <span class="p">}</span> 
<span class="p">}</span>
</code></pre></div></div><h3 id="apachehttpd">Apache/Httpd</h3><p>In case of Apache2/httpd similarlly, but just using a bit different directives, again assuming app availability on port 8080:</p><div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RequestHeader</span> <span class="ss">set</span> X-Forwarded-Proto "https"
<span class="nc">RewriteRule</span> ^/oauth2/(.*) http://localhost:8080/oauth2/$1 [P]
<span class="nc">ProxyPassReverse</span>  /oauth2 [http://localhost:8080/oauth2/](http://localhost:8080/oauth2/)
<span class="nc">RewriteRule</span> ^/login/oauth2/(.*) http://localhost:8080/login/oauth2/$1 [P]
<span class="nc">ProxyPassReverse</span>  /login/oauth2 http://localhost:8080/login/oauth2/
</code></pre></div></div><p>These custom rewrite rules are required because these endpoints are default oauth2 endpoints to which user is redirected before and after a login attempt.</p><h2 id="how-the-authorization-process-works">How the authorization process works</h2><p>Let’s see the tab in your browser to check how the whole process works.</p><ol><li>User accessed <a href="http://localhost:8080/api/v1/login">http://localhost:8080/api/v1/login</a></li><li><p>Because he was not logged-in (no appropriate cookie was sent as a request header) user is immediately redirected to authentication endpoint of your app <a href="http://localhost:8080/oauth2/authorization/azure">http://localhost:8080/oauth2/authorization/azure</a></p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/5.png" alt="Azure login form, redirected from our app endpoint" title="Azure login form, redirected from our app endpoint" /></p></li><li><p>This endpoint redirects user further, to login.microsoft page, along with information about which app did the redirect (this allows MS to sent back user to your app after he successfully authenticate):</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/6.png" alt="Pass of a redirect url" title="Pass of a redirect url" /></p></li><li><p>When the user passes the appropriate email and password, it’s redirected back to the application, to endpoint http://localhost:8080/login/oauth2/code/?code=0.AV… So to the redirect-uri that we’ve set in while registering the application in Azure. <strong>The code parameter is quite important here.</strong></p><p>The application sends the code and client_secret in a background (via so-called backchannel - a non-frontend HTTPS call, so the user of your app does not even know about this request) to Microsoft Azure to exchange it into a JWT token that contains some user data like email address. This happens directly after the user is redirected to the redirect URL, and it’s done by the microsoft library. Which data is sent by MS Azure in the JWT token as a response, depends on the permissions that application is granted.</p><p>Deep dive into application permissions are out of the scope of this article. You can check which permissions your app has by going to the azure console: “App registrations” -&gt; {your_app_name} -&gt; “API permissions”.</p><p>The JWT token can be used to fetch more data via Microsoft Graph API (but only data to which the user gave the permission). This for example can be used to get user groups/roles in order to authorize parts of the application only for administrators or other privileged users.</p><p>The redirect from Azure contains a response header “Set-Cookie” which indicates session initialization by the application. JSESSIONID is the id of the session. The “path=/” means that the cookie is set to all resources of the app, so the browser will append the JSESSIONID cookie to all requests under this origin (domain).</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/8.png" alt="Redirect user back to app, verify token and initalize session" title="Redirect user back to app, verify token and initalize session" /></p></li><li><p>Finally, after all of these jumps the user is allowed to access the endpoint he requested. User accessed the page because the session cookie has been sent via request header, and based on that JSESSIONID cookie, the application authorized user access to the requested resource:</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/7.png" alt="Authentication process finished" title="Authentication process finished" /></p></li></ol><h2 id="summary">Summary</h2><p><strong>You’ve made it till the end and now your app is secured with Azure OAuth, great work!</strong></p><p>Securing an application with an Identity Provider can simplify the application code and shift responsibility for securing users’ data from your application to the provider. Doing it with Azure AD is one of the multiple options, but all modern Identity Providers supports OAuth2 protocol that standardizes the Authorization process.</p></div><ul class="post__social"><li><a href="https://www.facebook.com/sharer/sharer.php?u=https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/" target="_blank"><i class="fa fa-facebook"></i></a></li><li><a href="https://twitter.com/intent/tweet?&text=Secure Spring Boot Application with Microsoft Azure AD+https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/+by+Łukasz Hyła" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?mini=true&source=Secure Spring Boot Application with Microsoft Azure AD&summary=Walkthrough on how to setup OAuth in a Java Spring based app using Microsoft Azure AD as a Identity Provider.&url=https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="https://www.reddit.com/submit?url=https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/" target="_blank"><i class="fa fa-reddit-alien"></i></a></li></ul></div></div><div class="section-padding--none"><div class="grid"><hr class="sep"/></div></div><div class="section-padding"><div class="grid-small"> Posted by<div class="post__author"> <img src="https://iterative.engineering/assets/images/team/lh.png" alt="Łukasz Hyła from Iterative Engineering"> <span> Łukasz Hyła<p class="post__bio">Software Engineer @ Iterative Engineering</p></span></div></div></div></article></div><section class="related section-padding"><div class="grid-xlarge"><h2 class="related__title">Related</h2><div class="related__container"><article class="related__post"> <a class="related__link" href="https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/"><figure class="related__img"> <img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/spring-and-ms-azure-ad.png" alt="Secure Spring Boot Application with Microsoft Azure AD"/></figure><div><h2 class="related__text">Secure Spring Boot Application with Microsoft Azure AD</h2></div></a></article></div></div></section></main><footer><div class="footer-wrapper"><div class="footer-section-wrapper"><div class="footer-section"><div><h4>DISCOVER OUR OFFER</h4><ul ><li><a href="/software-development-for-london-based-companies">Software Development for London Based Companies</a></li></ul></div><div><h4>FIND OUT WHAT WE WRITE ABOUT</h4><ul><li><a href="/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/">Secure Spring Boot Application with Microsoft Azure AD</a></li><li><a href="/2021/12/20/how-to-keep-the-team-integrated/">How to keep the team integrated despite physical distance</a></li><li><a href="/2021/12/10/key-8-takeaways-from-stackoverflow-2021-developers-survey/">Key 8 Takeaways from Stack Overflow 2021 Developers Survey</a></li><li><a href="/2021/09/28/creating-optimised-docker-images-using-multi-stage-builds/">Creating optimised Docker Images using Multi-Stage Builds</a></li><li><a href="/2021/07/09/how-to-avoid-overdesigning/">How to Avoid Overdesigning</a></li></ul></div></div><div class="footer-section"><div class="footer-contact-info"><h4>BUSINESS DEVELOPMENT</h4><div class="footer-segment-wrapper"> <img class="footer-img" src="/assets/images/krzysztofgasior.png" alt="Krzysztof Gąsior"><div class="flex-column address-wrapper"><address class="flex-column"><div class="footer-contact-person">Krzysztof Gąsior</div><div class="footer-contact-phone"> <a href="tel:+48 793901086">+48 793 901 086</a></div><div class="footer-contact-mail"> <a href="mailto:krzysztof.gasior@iterative.pl">krzysztof.gasior@iterative.pl</a></div></address><div class="schedule-meeting-button m-top-auto"> <a href="https://calendly.com/krzysztof-gasior" target="_blank" rel="noopener"> SCHEDULE A MEETING! </a></div></div></div></div><div class="footer-contact-info"><h4>HEADQUARTERS</h4><div class="footer-segment-wrapper"> <img class="footer-img" src="/assets/images/headquarters.png" alt="Headquarters location"><div class="flex-column"><address class="flex-column"><div class="footer-address">ul. Wolności 191/311<br>41-800 Zabrze, Silesia, Poland</div><div class="footer-contact-mail"> <a href="mailto:contact@iterative.pl">contact@iterative.pl</a></div></address></div></div></div><div class="widget"><div class="clutch-widget" data-url="https://widget.clutch.co" data-widget-type="2" data-height="45" data-theme="white" data-clutchcompany-id="746552"></div></div></div><div class="social-media"> <a href="https://github.com/IterativeEngineering" target="_blank" rel="noopener noreferrer nofollow"> <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10 0C4.47664 0 0 4.58996 0 10.2531C0 14.7824 2.86445 18.6261 6.83878 19.983C7.33908 20.0755 7.51955 19.7599 7.51955 19.4886C7.51955 19.2449 7.51153 18.5993 7.50852 17.7451C4.72629 18.3639 4.13876 16.3696 4.13876 16.3696C3.68558 15.1854 3.02887 14.8698 3.02887 14.8698C2.12152 14.2335 3.09806 14.2479 3.09806 14.2479C4.10267 14.3198 4.62904 15.3046 4.62904 15.3046C5.52136 16.8713 6.97112 16.419 7.5386 16.1568C7.62984 15.4938 7.89052 15.0415 8.17526 14.7855C5.95548 14.5275 3.62142 13.6475 3.62142 9.71755C3.62142 8.60013 4.01143 7.68316 4.64809 6.96769C4.54682 6.70761 4.20092 5.6642 4.74734 4.2538C4.74734 4.2538 5.58652 3.97728 7.49649 5.30338C8.29657 5.07619 9.14979 4.96209 9.999 4.95797C10.8502 4.96209 11.7044 5.07619 12.5015 5.30338C14.4125 3.97625 15.2507 4.2538 15.2507 4.2538C15.7971 5.6642 15.4542 6.70761 15.3499 6.96769C15.9916 7.68316 16.3766 8.5991 16.3766 9.71755C16.3766 13.6578 14.0405 14.5234 11.8127 14.7773C12.1686 15.0939 12.4895 15.7189 12.4895 16.675C12.4895 18.0463 12.4774 19.1524 12.4774 19.4886C12.4774 19.763 12.6559 20.0817 13.1662 19.981C17.1386 18.622 20 14.7814 20 10.2531C20 4.58996 15.5234 0 10 0Z" fill="#F9F9F9" /> </svg> </a> <a href="https://www.facebook.com/IterativeEngineering/" target="_blank" rel="noopener noreferrer nofollow"> <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 0C4.47745 0 0 4.50448 0 10.0604C0 15.081 3.65637 19.2424 8.43784 20V12.9691H5.89759V10.0604H8.43784V7.84385C8.43784 5.32046 9.93099 3.92897 12.2142 3.92897C13.3083 3.92897 14.4544 4.12516 14.4544 4.12516V6.59926H13.1903C11.9502 6.59926 11.5622 7.37599 11.5622 8.17185V10.0584H14.3334L13.8904 12.9671H11.5622V19.998C16.3436 19.2444 20 15.082 20 10.0604C20 4.50448 15.5226 0 10 0Z" fill="#F9F9F9" /> </svg> </a> <a href="https://linkedin.com/company/11263564/" target="_blank" rel="noopener noreferrer nofollow"> <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 20H15.5556V12.5C15.5556 11.3238 14.2357 10.3398 13.0595 10.3398C11.8832 10.3398 11.1111 11.3238 11.1111 12.5V20H6.66668V6.66667H11.1111V8.88889C11.847 7.69841 13.7293 6.9303 15.0278 6.9303C17.7739 6.9303 20 9.19845 20 11.9444V20ZM4.44444 20H0V6.66667H4.44444V20ZM2.22223 0C3.44953 0 4.44446 0.994922 4.44446 2.22222C4.44446 3.44952 3.44953 4.44444 2.22223 4.44444C0.994933 4.44444 1.11262e-05 3.44952 1.11262e-05 2.22222C1.11262e-05 0.994922 0.994933 0 2.22223 0Z" fill="#F9F9F9" /> </svg> </a></div></div></div><div class="footer-copyright-styles"><div class="copyright-wrapper"><div class="copyright-notice"> <span class="copyright-icon">2022 Iterative Engineering Sp. z o.o. - All rights reserved</span> <span class="legal-numbers"> NIP: 6482804153 | REGON: 388898977 | KRS: 0000900004 </span><div class="policy-links"> <span> <a href="cookies-policy.html" target="_blank" rel="noopener noreferrer nofollow">Cookies policy</a> </span> <span> <a href="privacy-policy.html" target="_blank" rel="noopener noreferrer nofollow">Privacy policy</a> </span></div></div><div class="social-media-inline"> <a href="https://github.com/IterativeEngineering" target="_blank" rel="noopener noreferrer nofollow"> <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10 0C4.47664 0 0 4.58996 0 10.2531C0 14.7824 2.86445 18.6261 6.83878 19.983C7.33908 20.0755 7.51955 19.7599 7.51955 19.4886C7.51955 19.2449 7.51153 18.5993 7.50852 17.7451C4.72629 18.3639 4.13876 16.3696 4.13876 16.3696C3.68558 15.1854 3.02887 14.8698 3.02887 14.8698C2.12152 14.2335 3.09806 14.2479 3.09806 14.2479C4.10267 14.3198 4.62904 15.3046 4.62904 15.3046C5.52136 16.8713 6.97112 16.419 7.5386 16.1568C7.62984 15.4938 7.89052 15.0415 8.17526 14.7855C5.95548 14.5275 3.62142 13.6475 3.62142 9.71755C3.62142 8.60013 4.01143 7.68316 4.64809 6.96769C4.54682 6.70761 4.20092 5.6642 4.74734 4.2538C4.74734 4.2538 5.58652 3.97728 7.49649 5.30338C8.29657 5.07619 9.14979 4.96209 9.999 4.95797C10.8502 4.96209 11.7044 5.07619 12.5015 5.30338C14.4125 3.97625 15.2507 4.2538 15.2507 4.2538C15.7971 5.6642 15.4542 6.70761 15.3499 6.96769C15.9916 7.68316 16.3766 8.5991 16.3766 9.71755C16.3766 13.6578 14.0405 14.5234 11.8127 14.7773C12.1686 15.0939 12.4895 15.7189 12.4895 16.675C12.4895 18.0463 12.4774 19.1524 12.4774 19.4886C12.4774 19.763 12.6559 20.0817 13.1662 19.981C17.1386 18.622 20 14.7814 20 10.2531C20 4.58996 15.5234 0 10 0Z" fill="#F9F9F9" /> </svg> </a> <a href="https://www.facebook.com/IterativeEngineering/" target="_blank" rel="noopener noreferrer nofollow"> <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 0C4.47745 0 0 4.50448 0 10.0604C0 15.081 3.65637 19.2424 8.43784 20V12.9691H5.89759V10.0604H8.43784V7.84385C8.43784 5.32046 9.93099 3.92897 12.2142 3.92897C13.3083 3.92897 14.4544 4.12516 14.4544 4.12516V6.59926H13.1903C11.9502 6.59926 11.5622 7.37599 11.5622 8.17185V10.0584H14.3334L13.8904 12.9671H11.5622V19.998C16.3436 19.2444 20 15.082 20 10.0604C20 4.50448 15.5226 0 10 0Z" fill="#F9F9F9" /> </svg> </a> <a href="https://linkedin.com/company/11263564/" target="_blank" rel="noopener noreferrer nofollow"> <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 20H15.5556V12.5C15.5556 11.3238 14.2357 10.3398 13.0595 10.3398C11.8832 10.3398 11.1111 11.3238 11.1111 12.5V20H6.66668V6.66667H11.1111V8.88889C11.847 7.69841 13.7293 6.9303 15.0278 6.9303C17.7739 6.9303 20 9.19845 20 11.9444V20ZM4.44444 20H0V6.66667H4.44444V20ZM2.22223 0C3.44953 0 4.44446 0.994922 4.44446 2.22222C4.44446 3.44952 3.44953 4.44444 2.22223 4.44444C0.994933 4.44444 1.11262e-05 3.44952 1.11262e-05 2.22222C1.11262e-05 0.994922 0.994933 0 2.22223 0Z" fill="#F9F9F9" /> </svg> </a></div></div></div></div></footer><script src="/assets/js/app.min.js?000e6330514fc297bbe6704a9ea0e57c"></script></body></html>
  