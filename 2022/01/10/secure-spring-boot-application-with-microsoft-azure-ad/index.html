<!DOCTYPE html><html lang="en"><meta http-equiv="X-UA-Compatible" content="IE=edge" /><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>Secure Spring Boot Application with Microsoft Azure AD</title><meta property="og:title" content="Secure Spring Boot Application with Microsoft Azure AD" /><meta property="og:site_name" content="Iterative Engineering Blog" /><meta name="author" content="Iterative Engineering Team" /><meta property="og:locale" content="en_GB" /><meta property="og:description" content="Walkthrough on how to setup OAuth in a Java Spring based app using Microsoft Azure AD as a Identity Provider." /><meta name="description" content="Walkthrough on how to setup OAuth in a Java Spring based app using Microsoft Azure AD as a Identity Provider." /><meta property="og:url" content="https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/" /><meta property="og:image" content="https://blog.iterative.engineering/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/spring-and-ms-azure-ad.webp" /><meta name="twitter:url" content="https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/" /><meta name="twitter:card" content="summary" /><meta name="twitter:title" content="Secure Spring Boot Application with Microsoft Azure AD | Iterative Engineering Blog" /><meta name="twitter:site" content="Iterative Engineering Blog" /><meta name="twitter:description" content="Walkthrough on how to setup OAuth in a Java Spring based app using Microsoft Azure AD as a Identity Provider." /><link rel="canonical" href="https://iterative.engineering" /><link rel="shortcut icon" href="/assets/images/favicon.png" /><link rel="stylesheet" href="/assets/css/app.min.css?68b77fc765da08f8b1409d0b1c20c22f" /><link rel="alternate" type="application/rss+xml" title="Iterative Engineering Blog" href="/feed.xml" /><link rel="canonical" href="/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/" /> <script defer type="text/javascript" src="https://widget.clutch.co/static/js/widget.js" ></script> <script defer type="text/javascript" src="/assets/js/main.js?68b77fc765da08f8b1409d0b1c20c22f" ></script> <script async type="fs-cc" fs-cc-categories="analytics" src="https://www.googletagmanager.com/gtag/js?id=UA-68442502-1" ></script> <script type="fs-cc" fs-cc-categories="analytics"> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-68442502-1'); </script> <script type="fs-cc" fs-cc-categories="analytics"> (function () { window.ldfdr = window.ldfdr || {}; (function (d, s, ss, fs) { fs = d.getElementsByTagName(s)[0]; function ce(src) { var cs = d.createElement(s); cs.src = src; setTimeout(function () { fs.parentNode.insertBefore(cs, fs) }, 1); } ce(ss); })(document, 'script', 'https://sc.lfeeder.com/lftracker_v1_lYNOR8xMKOG7WQJZ.js'); })(); </script> <script type="fs-cc" fs-cc-categories="analytics"> (function (c, l, a, r, i, t, y) { c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) }; t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i; y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y); })(window, document, "clarity", "script", "4g6s96579b"); </script> <script> function toggleClass() { const mobileMenu = document.querySelector(".mobile_menu-container"); mobileMenu.classList.toggle("toggleMenu"); const hambBcg = document.querySelector(".hamburger"); hambBcg.classList.toggle("hamburger_changeBcg"); } </script></head><body id="secure-spring-boot-application-with-microsoft-azure-ad" class="post-layout" ><header class="header"><div class="container"><nav class="navbar"> <a href="/" class="logo_wrapper-1920-xx"> <img src="/assets/images/nav/logo-without-blog.svg" alt="logo" /> </a> <a href="/" class="logo_wrapper"> <img src="/assets/images/nav/logo-all.svg" alt="logo" /> </a><ul class="menu"><li> <a href="/category/business">Business</a></li><li> <a href="/category/technical">Technical</a></li><li> <a href="/category/lifestyle">Lifestyle</a></li><li> <a id="homepage_btn" style=" background-color: rgb(95, 103, 170); padding: 0 32px; color: white; border: 0; font-family: 'Alexandria'; " href="https://iterative.engineering" >Go to the main page</a ></li></ul><div onclick="toggleClass()" class="hamburger"> <span class="hamb_bar"></span></div></nav><div class="mobile_menu-container"><ul class="menu_mobile"><li><a href="/category/business">Business</a></li><li><a href="/category/technical">Technical</a></li><li><a href="/category/lifestyle">Lifestyle</a></li><li> <a style=" text-decoration: underline; font-weight: bold; font-family: 'Alexandria'; " href="https://iterative.engineering" >Go to the main page</a ></li></ul></div></div></header><main><div class="post_container"><article class="post"><section class="post_header-wrapper"><div class="image-wrapper"><figure class="absolute-bg" style="background-image: url('/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/spring-and-ms-azure-ad.webp');" ></figure></div><div class="post-details"><h1>Secure Spring Boot Application with Microsoft Azure AD</h1><div class="title-separator"></div><div class="author-wrapper"> <img class="author-img" src="/assets/images/team/lh.webp" alt="Łukasz Hyła from Iterative Engineering" /><div class="author-bio"> <time class="post-date" datetime="2022-01-10T00:00:00-06:00" itemprop="datePublished" >10.01.2022 </time> <span class="author-name"> Łukasz Hyła</span> <span> Senior Software Engineer @ Iterative Engineering </span></div></div><div class="tag-container"> <span> <a class="tag primary-tag hide-on-mobile" href="/category/technical" >technical</a > </span><div class="secondary-tags"> <a class="tag primary-tag show-on-mobile" href="/category/technical" >technical</a > <a class="tag" href="/tag/java" title="Java" >#Java</a > <a class="tag" href="/tag/spring-framework" title="Spring Framework" >#Spring Framework</a > <a class="tag" href="/tag/azure" title="Azure" >#Azure</a > <a class="tag" href="/tag/azure-ad" title="Azure AD" >#Azure AD</a > <a class="tag" href="/tag/oauth" title="OAuth" >#OAuth</a ></div></div></div></section><section><div class="content"><p>Application security is an important part of cohesive digital product security and one for which typically software developers are responsible for. Handling it properly and according to industry standards is crucial, especially nowadays where literally anything that gets published is immediately targeted and scanned for vulnerabilities.</p><p>One of the most common challenges in that aspect is authentication &amp; authorization of the users. While there are many ways to do it, its really worth considering an external Identity Provider approach either via OAuth2 or SAML. The reason is that it typically gives great and proven security without the need to code and maintain the whole process, which is not trival!</p><p>This article presents an in detail walkthrough on how to secure a Java Spring Boot Application using Microsoft Azure AD, which is a great and widely adopted example of a reliable Identity Provider.</p><h4 id="who-may-find-this-article-helpful">Who may find this article helpful</h4><ul><li>Java developers experienced with Spring looking for ‘how to’ on pluging in Azure AD as Identity Provider into their apps.</li><li>Software Developers wishing to increase their knowledge around applications security and authentication schemes.</li></ul><p>If you belong to first group you may skip the first part and jump directly to the “Register application in Azure Tenant” chapter.</p><h4 id="what-will-you-learn">What will you learn</h4><ul><li>What are the advantages and disadvantages of using an external Identity Provider</li><li>How to configure and register your application in the Azure Tenant which is required to secure it by Azure AD</li><li>How to configure Spring Boot Application to secure it via Microsoft Identity Provider</li><li>How to configure Nginx / Apache as a reverse proxy when secured as such</li></ul><h4 id="example-project">Example project</h4><p>One to be found on GitHub: <a href="https://github.com/IterativeEngineering/blog.secure-spring-boot-application-with-microsoft-azure-ad">Spring Boot Secured App</a></p><h4 id="prerequisites">Prerequisites</h4><ul><li>Azure account with a subscription (e.g Pay as you go)</li><li>Java 11 or higher (or a docker container with such)</li></ul><h1 id="self-implemented-authentication--authorization">Self-implemented Authentication &amp; Authorization</h1><p>Imagine that in 2010 you have to prepare an application for e.g company managers. With different access levels. What would be your approach to achieve that? Most probably you would go with something similar to:</p><ol><li>Create a table of users + passwords and roles in the application</li><li>Prepare admin panel that allows to manage users and their privileges</li><li>Manage sessions (either as cookies or tokens) on the client web-app side and store them on the application server, e.g in memory or in DB</li><li>Implement features such as: Password restore</li></ol><p>A self baked authentication &amp; authorization system with local user information storage. Such setup, even today, is a common way to craft a prototype or MVP and it has advantages:</p><ul><li>low complexity - no 3rd party libraries, no external services engaged</li><li>data control - all users data are available and may be used the application</li></ul><p>However, it has also major disadvantages:</p><ul><li>vulnerability - Important user data are stored within the application. So they have to be well secured</li><li>maintenance problems - Roles/groups have to be managed in the app, not in a central point</li><li>limited extendability - Each feature such as 2FA, Single Sign-On have to be implemented, while implementing security mechanisms is costly and time consuming</li><li>lack of 3rd party systems integrations - For instance logging via Facebook or Google have to be implemented within the application. While services like Azure AD provide easy-to-use integrations.</li></ul><p>In the long term maintenance efforts could be significant, while not giving any benefits. So let’s look at alternatives.</p><h2 id="identity-providers-come-on-stage">Identity providers come on stage</h2><p>In 2007 OAuth 1.0 protocol was released and in 2012 its new version: Oauth 2.0 was released. This started a popularization process of external identity providers - systems that keep users data and provide these data to business applications with user acceptance.</p><p>OAuth 2.0 is widely supported by Microsoft, Google, Amazon etc. The solution I present in this article, while aimed at Microsoft Azure, could be implemented with other identity providers with minor tweaks.</p><h1 id="how-to-secure-spring-boot-with-azure-ad">How to secure Spring Boot with Azure AD</h1><p>Let’s go step by step through the configurations that have to be applied in the Microsoft Azure Portal, to secure the application using the Azure Active Directory.</p><ul><li>Register application in Microsoft Azure Tenant</li><li>Create &amp; Configure Java (Spring Boot) Application</li><li>Configure reverse proxy</li><li>Authenticate to the app (Test the setup)</li></ul><h2 id="register-application-in-azure-tenant">Register application in Azure Tenant</h2><p>Here are steps that are presented below on screenshots:</p><ul><li>Create a new Tenant</li><li>Register a new application &amp; set its allowed ‘redirect-uri’</li><li>Generate application secret</li></ul><h3 id="setup-a-new-tenant">Setup a new Tenant</h3><ol><li><p>Log in to portal.azure.com and search for Azure Active Directory service:</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/9.webp" alt="Search for Azure Active Directory" title="Search for Azure Active Directory" /></p></li><li><p>Select manage tenants:</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/15.webp" alt="Select manage tenants" title="Select manage tenants" /></p></li><li><p>Select basic tenant:</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/14.webp" alt="Select basic tenant" title="Select basic tenant" /></p></li><li><p>Finish the configuration and create it:</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/12.webp" alt="Finish the configuration and create it" title="Finish the configuration and create it" /></p></li><li><p>Once ready copy the tenant ID, as it will be neccessary further:</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/11.webp" alt="Once ready copy the tenant ID" title="Once ready copy the tenant ID" /></p></li></ol><h3 id="register-a-new-application--set-its-allowed-redirect-uri">Register a new application &amp; set its allowed ‘redirect-uri’</h3><ol><li><p>Select “App registrations” and “Register an application”</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/3.webp" alt="Register a new application via App registration" title="Register a new application via App registration" /></p></li><li><p>Define app name and set redirect URI:</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/2.webp" alt="Define app name and redirect URI" title="Define app name and redirect URI" /></p></li></ol><ul><li><strong>Name:</strong> Users will see this name e.g on the “Grant permissions” screen.</li><li><strong>Supported accounts types:</strong> By choosing option 1 only you and users from your tenant will be able to log in to the application. As you see, you can allow logging in to your application even for users who are not part of your organisation (option 2,3,4). Choose these options wisely, and only if your application does not expose any vulnerable data.</li><li><strong>Redirect URI:</strong> In our example it’s not optional. It’s the URL to which the user is redirected after a successful authentication on the Microsoft login page. If you deploy your application not on localhost but on some server, change localhost:8080 to the appropriate domain name.</li></ul><h3 id="create-a-secret">Create a Secret</h3><ol><li><p>Generate a new client secret <img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/10.webp" alt="Add certificate or secret" title="Add certificate or secret" /></p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/4.webp" alt="Create new client secret" title="Create new client secret" /></p><p>Note: All secrets have to have an expiration date and they can’t be renewed, so if a secret expires, you can generate a new secret and update it in your application.</p></li><li><p>Copy and save the Secret value (it is visible only just after secret creation)</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/16.webp" alt="Copy and save generated Secret" title="Copy and save generated Secret" /></p></li></ol><p><strong>Never reveal the Secret to anyone nor publish it to public repositories!</strong></p><p>Great! At this point the setup on the Azure side is now complete, let’s move on to the application.</p><h2 id="configure-spring-boot-application">Configure Spring-Boot application</h2><p>Key things that have to be created:</p><ul><li>Dependency to the azure spring-boot library that does the ‘magic’ and simplifies integration between SpringBoot app and our Azure Tenant</li><li>Properties that allow the app to connect to the Azure Tenant</li><li>Rest controller that will be used for tests</li></ul><p>Here is an example build.gradle file, but a similar setup could be done in maven pom.xml.</p><p><em>build.gradle</em></p><div class="language-gradle highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plugins</span> <span class="o">{</span>
  <span class="n">id</span> <span class="s2">"org.springframework.boot"</span> <span class="n">version</span> <span class="s2">"2.5.0"</span>
  <span class="n">id</span> <span class="s1">'io.spring.dependency-management'</span> <span class="n">version</span> <span class="s1">'1.0.6.RELEASE'</span>
  <span class="n">id</span> <span class="s1">'java'</span>
<span class="o">}</span>

<span class="n">group</span> <span class="o">=</span> <span class="s1">'pl.iterative'</span>

<span class="n">version</span> <span class="o">=</span> <span class="s1">'1.0.0-SNAPSHOT'</span>

<span class="k">repositories</span> <span class="o">{</span>
  <span class="n">mavenLocal</span><span class="o">()</span>
  <span class="n">mavenCentral</span><span class="o">()</span>
  <span class="n">gradlePluginPortal</span><span class="o">()</span>
<span class="o">}</span>

<span class="k">dependencies</span> <span class="o">{</span>

  <span class="c1">// Spring boot</span>
  <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-oauth2-client'</span>
  <span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-web'</span>

  <span class="c1">// Azure</span>
  <span class="n">implementation</span> <span class="s1">'com.azure.spring:azure-spring-boot-starter-active-directory:3.5.0'</span>

<span class="o">}</span>
</code></pre></div></div><p><em>application.properties</em></p><div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">server.port</span> <span class="p">=</span> <span class="s">8080</span>
<span class="py">azure.activedirectory.tenant-id</span> <span class="p">=</span> <span class="s">e76d7581-eabe-4e6b-a676-55e28d9325ee</span>
<span class="py">azure.activedirectory.client-id</span> <span class="p">=</span> <span class="s">4b37344a-6dda-4e10-9f02-359477227f25</span>
<span class="py">azure.activedirectory.client-secret</span> <span class="p">=</span> <span class="s">SECRET_VALUE_HERE</span>
</code></pre></div></div><p><em>Application.java</em></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">pl.iterative</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Application</span> <span class="o">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">Application</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
 <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p><em>AuthController.java</em></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">pl.iterative.api</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/api"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthController</span> <span class="o">{</span>
 <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
 <span class="kd">public</span> <span class="nc">String</span> <span class="nf">login</span><span class="o">()</span> <span class="o">{</span>
   <span class="k">return</span> <span class="s">"User logged in"</span><span class="o">;</span>
 <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>The default setup restricts access to all application endpoints. If you wish to customize following article describes how to implement custom security configuration: <a href="https://www.baeldung.com/java-config-spring-security#Security">https://www.baeldung.com/java-config-spring-security#Security</a></p><p>For the sake of this tutorial we will stick to defaults. Once the app is prepared as above config we can run it and access the resource: <a href="http://localhost:8080/api/v1/login">http://localhost:8080/api/login</a> via a web browser.</p><p>On the first login attempt, the user is asked to consent to grant the permissions that the application requests. Always grant this consent carefully, especially to applications you don’t develop, and check precisely which exact permissions you’re granting.</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/13.webp" alt="Microsoft Azure permission request for identity data" title="Microsoft Azure permission request for identity data" /></p><p>A successful log-in process is finished, when user accesses the requested resource:</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/17.webp" alt="URL if login is successfuly" title="URL if login is successfuly" /></p><p>What actually happens during the authorization process is described further in the article.</p><h2 id="configure-nginx--apache-reverse-proxy">Configure Nginx / Apache reverse proxy</h2><p>So while we got the Spring App and Azure AD to work together it’s common scenario to put app behind a reverse proxy like Nginx or Apache.</p><p>However such case implies requirement for additional set up, as we need to properly handle headers and redirects on proxy side.</p><h3 id="app-config">App config</h3><p>Add following entries to the application.properties, as first we need to let know app that its behind the proxy.</p><p><em>application.properties</em></p><div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">server.forward-headers-strategy</span> <span class="p">=</span> <span class="s">FRAMEWORK</span>
<span class="py">server.tomcat.redirect-context-root</span> <span class="p">=</span> <span class="s">false</span>
</code></pre></div></div><h3 id="nginx">Nginx</h3><p>If using Nginx as a proxy, we nned to set proxy_set_header directives and a proxy rule for <code class="language-plaintext highlighter-rouge">/oauth2</code> endpoint, so roughly like following, assuming the app is accessible on localhost under port 8080:</p><div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
  <span class="kn">proxy_set_header</span>     <span class="s">X-Forwarded-Proto</span>   <span class="nv">$scheme</span><span class="p">;</span>
  <span class="kn">location</span> <span class="n">/oauth2</span> <span class="p">{</span>
    <span class="kn">proxy_pass</span> <span class="s">http://localhost:8080/oauth2</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kn">location</span> <span class="n">/login/oauth2</span> <span class="p">{</span>
    <span class="kn">proxy_pass</span> <span class="s">http://localhost:8080/login/oauth2</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="apachehttpd">Apache/Httpd</h3><p>In case of Apache2/httpd similarlly, but just using a bit different directives, again assuming app availability on port 8080:</p><div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RequestHeader</span> <span class="ss">set</span> X-Forwarded-Proto "https"
<span class="nc">RewriteRule</span> ^/oauth2/(.*) http://localhost:8080/oauth2/$1 [P]
<span class="nc">ProxyPassReverse</span>  /oauth2 [http://localhost:8080/oauth2/](http://localhost:8080/oauth2/)
<span class="nc">RewriteRule</span> ^/login/oauth2/(.*) http://localhost:8080/login/oauth2/$1 [P]
<span class="nc">ProxyPassReverse</span>  /login/oauth2 http://localhost:8080/login/oauth2/
</code></pre></div></div><p>These custom rewrite rules are required because these endpoints are default oauth2 endpoints to which user is redirected before and after a login attempt.</p><h2 id="how-the-authorization-process-works">How the authorization process works</h2><p>Let’s see the tab in your browser to check how the whole process works.</p><ol><li>User accessed <a href="http://localhost:8080/api/v1/login">http://localhost:8080/api/v1/login</a></li><li><p>Because he was not logged-in (no appropriate cookie was sent as a request header) user is immediately redirected to authentication endpoint of your app <a href="http://localhost:8080/oauth2/authorization/azure">http://localhost:8080/oauth2/authorization/azure</a></p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/5.webp" alt="Azure login form, redirected from our app endpoint" title="Azure login form, redirected from our app endpoint" /></p></li><li><p>This endpoint redirects user further, to login.microsoft page, along with information about which app did the redirect (this allows MS to sent back user to your app after he successfully authenticate):</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/6.webp" alt="Pass of a redirect url" title="Pass of a redirect url" /></p></li><li><p>When the user passes the appropriate email and password, it’s redirected back to the application, to endpoint http://localhost:8080/login/oauth2/code/?code=0.AV… So to the redirect-uri that we’ve set in while registering the application in Azure. <strong>The code parameter is quite important here.</strong></p><p>The application sends the code and client_secret in a background (via so-called backchannel - a non-frontend HTTPS call, so the user of your app does not even know about this request) to Microsoft Azure to exchange it into a JWT token that contains some user data like email address. This happens directly after the user is redirected to the redirect URL, and it’s done by the microsoft library. Which data is sent by MS Azure in the JWT token as a response, depends on the permissions that application is granted.</p><p>Deep dive into application permissions are out of the scope of this article. You can check which permissions your app has by going to the azure console: “App registrations” -&gt; {your_app_name} -&gt; “API permissions”.</p><p>The JWT token can be used to fetch more data via Microsoft Graph API (but only data to which the user gave the permission). This for example can be used to get user groups/roles in order to authorize parts of the application only for administrators or other privileged users.</p><p>The redirect from Azure contains a response header “Set-Cookie” which indicates session initialization by the application. JSESSIONID is the id of the session. The “path=/” means that the cookie is set to all resources of the app, so the browser will append the JSESSIONID cookie to all requests under this origin (domain).</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/8.webp" alt="Redirect user back to app, verify token and initalize session" title="Redirect user back to app, verify token and initalize session" /></p></li><li><p>Finally, after all of these jumps the user is allowed to access the endpoint he requested. User accessed the page because the session cookie has been sent via request header, and based on that JSESSIONID cookie, the application authorized user access to the requested resource:</p><p><img src="/assets/images/secure-spring-boot-application-with-microsoft-azure-ad/7.webp" alt="Authentication process finished" title="Authentication process finished" /></p></li></ol><h2 id="summary">Summary</h2><p><strong>You’ve made it till the end and now your app is secured with Azure OAuth, great work!</strong></p><p>Securing an application with an Identity Provider can simplify the application code and shift responsibility for securing users’ data from your application to the provider. Doing it with Azure AD is one of the multiple options, but all modern Identity Providers supports OAuth2 protocol that standardizes the Authorization process.</p></div><div class="table-content"><div class="share-with-friends"> <span>Share with friends:</span><ul class="post__social"><li><a href="https://www.facebook.com/sharer/sharer.php?u=https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/" target="_blank"><i class="fa fa-facebook"></i></a></li><li><a href="https://twitter.com/intent/tweet?&text=Secure Spring Boot Application with Microsoft Azure AD+https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/+by+Łukasz Hyła" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?mini=true&source=Secure Spring Boot Application with Microsoft Azure AD&summary=Walkthrough on how to setup OAuth in a Java Spring based app using Microsoft Azure AD as a Identity Provider.&url=https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="https://www.reddit.com/submit?url=https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/" target="_blank"><i class="fa fa-reddit-alien"></i></a></li></ul></div><div class="content-header">CONTENTS:</div><div id="intro-link"> <a href="#secure-spring-boot-application-with-microsoft-azure-ad">Secure Spring Boot Application with Microsoft Azure AD</a></div><div><div id="table-of-contents" class="toc"><ul id="toc" class="section-nav"><li class="toc-entry toc-h4"><a href="#who-may-find-this-article-helpful">Who may find this article helpful</a></li><li class="toc-entry toc-h4"><a href="#what-will-you-learn">What will you learn</a></li><li class="toc-entry toc-h4"><a href="#example-project">Example project</a></li><li class="toc-entry toc-h4"><a href="#prerequisites">Prerequisites</a></li><li class="toc-entry toc-h1"><a href="#self-implemented-authentication--authorization">Self-implemented Authentication &amp; Authorization</a><ul><li class="toc-entry toc-h2"><a href="#identity-providers-come-on-stage">Identity providers come on stage</a></li></ul></li><li class="toc-entry toc-h1"><a href="#how-to-secure-spring-boot-with-azure-ad">How to secure Spring Boot with Azure AD</a><ul><li class="toc-entry toc-h2"><a href="#register-application-in-azure-tenant">Register application in Azure Tenant</a><ul><li class="toc-entry toc-h3"><a href="#setup-a-new-tenant">Setup a new Tenant</a></li><li class="toc-entry toc-h3"><a href="#register-a-new-application--set-its-allowed-redirect-uri">Register a new application &amp; set its allowed ‘redirect-uri’</a></li><li class="toc-entry toc-h3"><a href="#create-a-secret">Create a Secret</a></li></ul></li><li class="toc-entry toc-h2"><a href="#configure-spring-boot-application">Configure Spring-Boot application</a></li><li class="toc-entry toc-h2"><a href="#configure-nginx--apache-reverse-proxy">Configure Nginx / Apache reverse proxy</a><ul><li class="toc-entry toc-h3"><a href="#app-config">App config</a></li><li class="toc-entry toc-h3"><a href="#nginx">Nginx</a></li><li class="toc-entry toc-h3"><a href="#apachehttpd">Apache/Httpd</a></li></ul></li><li class="toc-entry toc-h2"><a href="#how-the-authorization-process-works">How the authorization process works</a></li><li class="toc-entry toc-h2"><a href="#summary">Summary</a></li></ul></li></ul></div></div></div></section><section class="sharing-section"><div class="author-wrapper-mobile"> <img class="author-img" src="/assets/images/team/lh.webp" alt="Łukasz Hyła from Iterative Engineering" /><div class="author-bio"> <time class="post-date" datetime="2022-01-10T00:00:00-06:00" itemprop="datePublished" >10.01.2022 </time> <span class="author-name"> Łukasz Hyła</span> <span> Senior Software Engineer @ Iterative Engineering </span></div></div><div class="share-with-friends share-with-friends-two"> <span>Share with friends:</span><ul class="post__social"><li><a href="https://www.facebook.com/sharer/sharer.php?u=https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/" target="_blank"><i class="fa fa-facebook"></i></a></li><li><a href="https://twitter.com/intent/tweet?&text=Secure Spring Boot Application with Microsoft Azure AD+https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/+by+Łukasz Hyła" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?mini=true&source=Secure Spring Boot Application with Microsoft Azure AD&summary=Walkthrough on how to setup OAuth in a Java Spring based app using Microsoft Azure AD as a Identity Provider.&url=https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="https://www.reddit.com/submit?url=https://blog.iterative.engineering/2022/01/10/secure-spring-boot-application-with-microsoft-azure-ad/" target="_blank"><i class="fa fa-reddit-alien"></i></a></li></ul></div></section></article><section class="related_posts-container"><div class="related-posts"><h2 style="margin-top:0px;padding-top:calc(var(--spacing--A)/ 4);">Related</h2><div class="related-posts-separator"></div><div class="posts-items"> <a class="posts__link" href="/2024/04/29/secure-vps-with-cloud-flare-zero-trust-in-5min/" itemprop="url" ><div class="related_post-item"> <span class="related_post-item-tag">technical</span> <img class="related_post-img" src="/assets/images/secure-vps-with-cloud-flare-zero-trust-in-5min/zero-trust-network-image.webp" alt="Secure VPS with CloudFlare Zero Trust in 5min" data-aos="fade-in" itemprop="image" /><div class="related_post-aligner"><h4 className="related_post-title">Secure VPS with CloudFlare Zero Trust in 5min</h4><p class="related_post-content"> You've probably heard about the **xz backdoor**, which has unsettled admins all around the world, and you likely still remember Log4Shell - another CVE10 that sent shockwaves through IT security teams a few years back....</p><div class="related_post-separator"></div><div class="related_author-wrapper"> <img class="author-img" src="/assets/images/team/lh.webp" alt="Łukasz Hyła from Iterative Engineering" /><div class="author-bio"> <time class="post-date" datetime="2024-04-29T00:00:00-05:00" itemprop="datePublished" >29.04.2024 </time> <span class="author-name"> Łukasz Hyła</span> <span class="author-details"> Senior Software Engineer @ Iterative Engineering </span></div></div></div></div></a> <a class="posts__link" href="/2024/03/20/strengths-and-limitations-of-knip-for-unused-code-detection-in-angular/" itemprop="url" ><div class="related_post-item"> <span class="related_post-item-tag">technical</span> <img class="related_post-img" src="/assets/images/strengths-and-limitations-of-knip-for-unused-code-detection-in-angular/main.webp" alt="Strengths and Limitations of Knip for Unused Code Detection in Angular" data-aos="fade-in" itemprop="image" /><div class="related_post-aligner"><h4 className="related_post-title">Strengths and Limitations of Knip for Unused Code Detection in Angular</h4><p class="related_post-content"> As the codebase grows and evolves, the cost of maintaining it becomes higher. In extreme cases, leading to situations where upkeep takes significantly more time and effort than new developments. While you cannot prevent balancing...</p><div class="related_post-separator"></div><div class="related_author-wrapper"> <img class="author-img" src="/assets/images/team/ml.webp" alt="Marcin Licznerski from Iterative Engineering" /><div class="author-bio"> <time class="post-date" datetime="2024-03-20T00:00:00-05:00" itemprop="datePublished" >20.03.2024 </time> <span class="author-name"> Marcin Licznerski</span> <span class="author-details"> Senior Software Engineer @ Iterative Engineering </span></div></div></div></div></a> <a class="posts__link" href="/2022/08/22/battling-ad-fraud-spoofed-browsers-detection/" itemprop="url" ><div class="related_post-item"> <span class="related_post-item-tag">technical</span> <img class="related_post-img" src="/assets/images/battling-ad-fraud-spoofed-browsers-detection/battling-ad-fraud-spoofed-browsers-detection.webp" alt="Battling Ad Fraud - Spoofed Browsers Detection" data-aos="fade-in" itemprop="image" /><div class="related_post-aligner"><h4 className="related_post-title">Battling Ad Fraud - Spoofed Browsers Detection</h4><p class="related_post-content"> $68bn worldwide of total ad spend will fall victim to fraudsters in 2022 alone. So what is AdTech doing to fight off fraud and what kind of technical challenges is it facing? Detecting if ad...</p><div class="related_post-separator"></div><div class="related_author-wrapper"> <img class="author-img" src="/assets/images/team/kg.webp" alt="Krzysztof Gąsior from Iterative Engineering" /><div class="author-bio"> <time class="post-date" datetime="2022-08-22T00:00:00-05:00" itemprop="datePublished" >22.08.2022 </time> <span class="author-name"> Krzysztof Gąsior</span> <span class="author-details"> CEO @ Iterative Engineering </span></div></div></div></div></a></div></div></section></div></main><footer class="footer_container"><div class="main_content-wrapper"><div class="main_content"><div class="column-left"><div class="headquarter"><h4 class="headers">HEADQUARTERS</h4><div class="address text_line-spacing"> <img class="column_left-icon" src="/assets/images/icons/location-pin-icon.svg" alt="location" /><div class="location"> <span>&nbsp;ul. Wolności 191/311</span> <span>&nbsp;41-800 Zabrze, Silesia, Poland</span></div></div><div class="text_line-spacing"> <img class="column_left-icon" src="/assets/images/icons/mail-icon.svg" alt="email" /> <a class="text-hover" href="mailto:office@iterative.pl" >office@iterative.pl</a ></div></div><div class="business-development"><h4 class="headers">BUSINESS DEVELOPMENT</h4><div class="text_line-spacing"> <img class="column_left-icon" src="/assets/images/icons/person-icon.svg" alt="email" /> <span>Krzysztof Gąsior</span></div><div> <img class="column_left-icon" src="/assets/images/icons/phone-icon.svg" alt="email" /> <a class="text_line-spacing text-hover" href="tel:+48793901086" >+48 793 901 086</a ></div><div class="contact-meeting"> <img class="column_left-icon" src="/assets/images/icons/mail-icon.svg" alt="email" /> <a class="text_line-spacing text-hover" href="mailto:krzysztof.gasior@iterative.pl" >krzysztof.gasior@iterative.pl</a > <a class="link_schedule-meeting" href="https://calendly.com/krzysztof-gasior/" target="_blank" > <button class="schedule-meeting">Schedule a meeting</button> </a></div></div><div class="clutch-widget" data-url="https://widget.clutch.co" data-widget-type="2" data-height="45" data-theme="white" data-clutchcompany-id="746552" ></div></div><div class="separator"></div><div class="right-column"><div><h4 class="headers">FIND OUT WHAT WE WRITE ABOUT</h4><a class="text_line-spacing text-hover" href="/2024/09/12/iterative-engineering-new-address/" >Iterative Engineering changes its address</a ><br /> <a class="text_line-spacing text-hover" href="/2024/07/12/iterative-delivers-innovative-solution-for-biomethane/" >Iterative Engineering delivers AI solution for biomethane plant development</a ><br /> <a class="text_line-spacing text-hover" href="/2024/04/29/secure-vps-with-cloud-flare-zero-trust-in-5min/" >Secure VPS with CloudFlare Zero Trust in 5min</a ><br /> <a class="text_line-spacing text-hover" href="/2024/03/20/strengths-and-limitations-of-knip-for-unused-code-detection-in-angular/" >Strengths and Limitations of Knip for Unused Code Detection in Angular</a ><br /> <a class="text_line-spacing text-hover" href="/2024/01/14/teaching-java-reflections-on-the-attempt/" >Teaching Java: Reflections on the Attempt</a ><br /></div><div class="discover-offer"><h4 class="headers">DISCOVER OUR OFFER</h4><a class="text_line-spacing text-hover" href="https://iterative.engineering/software-development-for-london-based-companies" >Software Development for London Based Companies</a ><br /> <a class="text_line-spacing text-hover" href="https://iterative.engineering/software-development-for-aberdeen-based-companies" >Software Development for Aberdeen Based Companies</a ><br /> <a class="text_line-spacing text-hover" href="https://iterative.engineering/digital-product-development-for-fintech" >Digital Product Development for Fintech</a ><br /></div><div class="menu_footer"><h4 class="headers">Menu</h4><a class="text_line-spacing text-hover" href="https://iterative.engineering/" >Home</a ><br /> <a class="text_line-spacing text-hover" href="https://iterative.engineering/about.html" >About us</a ><br /> <a class="text_line-spacing text-hover" href="https://iterative.engineering/services.html" >Services</a ><br /> <a class="text_line-spacing text-hover" href="/" style="color: #e1e3e4; font-weight: 700" >Blog</a ></div></div></div></div><div class="bottom_bar-container"><div class="bottom_bar-policy-social"><div class="bottom_bar-policy-info"><div class="company-info"><div class="bottom_bar-copyrights"> <img class="bottom_bar-copyright-icon" src="/assets/images/icons/copyright.svg" alt="copyright" /> <span class="bottom_bar-text bottom_bar-rights_text"> 2024 Iterative Engineering Sp. z o.o. - All rights reserved </span></div><span class="bottom_bar-text" >VAT-EU: PL6482804153 | REGON: 388898977 | KRS: 0000900004 </span></div><div class="policy_container"> <a class="bottom_bar-text" href="/cookies-policy.html" target="_blank" rel="noopener noreferrer nofollow" >Cookies policy</a > <a class="bottom_bar-text" href="https://iterative.engineering/privacy-policy.html" target="_blank" rel="noopener noreferrer nofollow" >Privacy policy</a ></div></div><div class="bottom_bar-social-icons"> <a href="https://clutch.co/profile/iterative-engineering#summary" target="_blank" rel="noopener noreferrer nofollow" > <img class="social-icons" src="/assets/images/icons/clutch-icon.svg" alt="clutch profile" /> </a> <a href="https://github.com/IterativeEngineering" target="_blank" rel="noopener noreferrer nofollow" > <img class="social-icons" src="/assets/images/icons/github-icon.svg" alt="github profile" /> </a> <a href="https://www.facebook.com/IterativeEngineering/" target="_blank" rel="noopener noreferrer nofollow" > <img class="social-icons" src="/assets/images/icons/fb-icon.svg" alt="facebook profile" /> </a> <a href="https://linkedin.com/company/11263564/" target="_blank" rel="noopener noreferrer nofollow" > <img class="social-icons" src="/assets/images/icons/linkedin-icon.svg" alt="linkedin profile" /> </a></div></div></div></footer><script src="/assets/js/app.min.js?68b77fc765da08f8b1409d0b1c20c22f"></script><div class="cookies-container cookies"><div fs-cc="banner" class="fs-cc-banner_component"><div class="fs-cc-banner_container"><div class="fs-cc-banner_text"> By clicking <strong style="color: var(--primary-font-color)">“Accept”</strong>, you agree to the storing of cookies on your device to enhance site navigation, analyze site usage, and assist in our marketing efforts. View our <a href="/cookies-policy.html" target="_blank" rel="noopener noreferrer nofollow" class="fs-cc-banner_text-link" >Privacy Policy</a > for more information.</div><div class="fs-cc-banner_buttons-wrapper"> <a fs-cc="open-preferences" href="#!" class="fs-cc-banner_text-link" tabindex="0" >Preferences</a ><div class="buttons-prefs-container"> <a fs-cc="deny" href="#!" class="fs-cc-banner_button fs-cc-button-alt w-button" tabindex="0" >Deny</a > <a fs-cc="allow" href="#!" class="fs-cc-banner_button w-button confirm-cookies" tabindex="0" >Accept</a ></div><div fs-cc="close" class="fs-cc-banner_close" tabindex="0"><div class="fs-cc-banner_close-icon"> <svg fill="currentColor" aria-hidden="true" focusable="false" viewBox="0 0 16 16" ><path d="M9.414 8l4.293-4.293-1.414-1.414L8 6.586 3.707 2.293 2.293 3.707 6.586 8l-4.293 4.293 1.414 1.414L8 9.414l4.293 4.293 1.414-1.414L9.414 8z" ></path> </svg></div></div></div></div></div></div><div fs-cc-scroll="disable" fs-cc="preferences" class="fs-cc-prefs_component-2 w-form" style="display: none" > <form id="cookie-preferences" class="fs-cc-prefs_form" aria-label="Cookie Preferences" ><div fs-cc="close" class="fs-cc-prefs_close" role="button" tabindex="0"><div class="fs-cc-prefs_close-icon-2 w-embed"> <svg fill="currentColor" aria-hidden="true" focusable="false" viewBox="0 0 16 16" ><path d="M9.414 8l4.293-4.293-1.414-1.414L8 6.586 3.707 2.293 2.293 3.707 6.586 8l-4.293 4.293 1.414 1.414L8 9.414l4.293 4.293 1.414-1.414L9.414 8z" ></path> </svg></div></div><div class="fs-cc-prefs_content"><div class="fs-cc-prefs_space-small"><div class="fs-cc-prefs_title">Privacy Preference Center</div></div><div class="fs-cc-prefs_space-small"><div class="fs-cc-prefs_text"> When you visit websites, they may store or retrieve data in your browser. This storage is often necessary for the basic functionality of the website. The storage may be used for marketing, analytics, and personalization of the site, such as storing your preferences. Privacy is important to us, so you have the option of disabling certain types of storage that may not be necessary for the basic functioning of the website. Blocking categories may impact your experience on the website.</div></div><div class="fs-cc-prefs_space-medium"> <a fs-cc="deny" href="#!" class="fs-cc-prefs_button fs-cc-button-alt w-button" role="button" tabindex="0" >Reject all cookies</a > <a fs-cc="allow" href="#!" class="fs-cc-prefs_button w-button" role="button" tabindex="0" >Allow all cookies</a ></div><div class="fs-cc-prefs_space-small"><div class="fs-cc-prefs_title"> Manage Consent Preferences by Category</div></div><div class="fs-cc-prefs_option _1st"><div class="fs-cc-prefs_toggle-wrapper"><div class="fs-cc-prefs_label">Essential</div><div class="fs-cc-prefs_text"><strong>Always Active</strong></div></div><div class="fs-cc-prefs_text"> These items are required to enable basic website functionality.</div></div><div class="fs-cc-prefs_option"><div class="fs-cc-prefs_toggle-wrapper"><div class="fs-cc-prefs_label">Analytics</div><label style="position: relative"> <input type="checkbox" fs-cc-checkbox="analytics" class="fs-cc-prefs_checkbox" /><div class="fs-cc-prefs_checkbox-field"><div class="fs-cc-prefs_toggle"></div></div></label></div><div class="fs-cc-prefs_text"> These items help the website operator understand how its website performs, how visitors interact with the site, and whether there may be technical issues. This storage type usually doesn’t collect information that identifies a visitor.</div></div><div class="fs-cc-prefs_buttons-wrapper"> <a fs-cc="submit" href="#!" class="fs-cc-prefs_button w-button" role="button" tabindex="0" >Confirm my preferences and close</a ></div></div></form><div fs-cc="close" class="fs-cc-prefs_overlay"></div></div><script async src="https://cdn.jsdelivr.net/npm/@finsweet/cookie-consent@1/fs-cc.js" ></script></body></html>
  